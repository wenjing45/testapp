<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>章鱼喷墨机</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/kGYP6CQw/6.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        /* --- 全局与主题样式 --- */
        :root {
            --bg-color: #fce4ec;
            --primary-color: #ff80ab;
            --secondary-color: #f48fb1;
            --accent-color: #90caf9;
            --text-color: #444;
            --white-color: #fff;
            --border-radius: 18px; 
            --phone-corner-radius: 0px;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --top-pinned-bg: #fff0f5; 
            --online-status-color: #4CAF50;
        }
        
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: var(--font-family); margin: 0; padding: 0;
            background: linear-gradient(135deg, #fce4ec, #f8bbd0);
            display: flex; align-items: center; justify-content: center; min-height: 100vh;
        }

        .phone-screen {
            width: 100%; max-width: 420px; height: 100vh; max-height: 850px;
            background-color: var(--white-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-radius: var(--phone-corner-radius);
            overflow: hidden; position: relative;
            display: flex; flex-direction: column;
        }
        .screen { display: none; flex-direction: column; width: 100%; height: 100%; animation: fadeIn 0.5s ease; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        .app-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 20px; background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px); border-bottom: 1px solid #eee;
            flex-shrink: 0; position: relative; z-index: 10;
        }
        .app-header .back-btn, .app-header .action-btn {
            background: none; border: none; font-size: 24px; font-weight: bold;
            color: var(--primary-color); cursor: pointer; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
        }
        #cancel-multi-select-btn {
            font-size: 14px !important;                 
            font-weight: 500 !important;                
            color: var(--white-color) !important;       
            background-color: var(--primary-color) !important; 
            border-radius: 10px !important;             
            padding: 5px 10px !important;               
            width: auto !important;                     
            height: auto !important;                    
        }
        .app-header .action-btn-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .app-header .action-btn-group .action-btn {
            font-size: 16px;
            font-weight: 600;
            width: auto;
            padding: 6px 12px;
            border-radius: 10px;
        }
        .app-header .action-btn-group #create-group-btn {
            background-color: var(--primary-color);
            color: var(--white-color);
        }
         .app-header .action-btn-group #add-chat-btn {
            font-size: 28px;
            padding: 0;
            width: 40px;
            height: 40px;
            background-color: transparent;
            color: var(--primary-color);
            border-radius: 50%;
        }

        .app-header .action-btn img { width: 28px; height: 28px; }
        .app-header .title-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        .app-header .title { font-size: 18px; font-weight: 600; color: var(--text-color); margin: 0; }
        .app-header .subtitle { 
            font-size: 12px; color: #888; display: flex; align-items: center; 
            margin-top: 2px;
        }
        .online-indicator {
            width: 8px; height: 8px; border-radius: 50%;
            background-color: var(--online-status-color);
            margin-right: 5px;
        }
        .app-header .placeholder { width: 40px; }
        
        #home-screen { justify-content: space-between; background-size: cover; background-position: center; transition: background-image 0.5s ease-in-out; padding: 50px 0; }
        .time-widget { text-align: center; padding: 0 20px; color: var(--text-color); }
        .time-widget .time { font-size: 72px; font-weight: 600; }
        .time-widget .date { font-size: 18px; color: #666; }
        .app-grid { width: 100%; padding: 20px 40px; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; justify-content: center; align-content: center; margin-top: 40px; }
        
        #home-screen.day-mode .time-widget,
        #home-screen.day-mode .time-widget .date,
        #home-screen.day-mode .app-icon .app-name {
            color: var(--white-color);
            text-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }
        
        .dock { display: flex; justify-content: center; align-items: center; padding: 10px; background-color: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border-radius: var(--border-radius); margin: 0 20px; min-height: 80px; gap: 15px; }
        .app-icon { display: flex; flex-direction: column; align-items: center; cursor: pointer; text-decoration: none; }
        .icon-img { width: 60px; height: 60px; border-radius: 15px; margin-bottom: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s ease; object-fit: cover; }
        .app-icon:hover .icon-img { transform: translateY(-5px); }
        .app-icon .app-name { font-size: 12px; color: var(--text-color); font-weight: 500; }

        .content { flex-grow: 1; overflow-y: auto; padding: 20px; position: relative; }
        .placeholder-text { text-align: center; color: #aaa; margin-top: 50px; }
        
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 100; display: none; align-items: center; justify-content: center; animation: fadeIn 0.3s ease; }
        .modal-overlay.visible { display: flex; }
        .modal-window { background: var(--white-color); padding: 25px; border-radius: var(--border-radius); box-shadow: 0 5px 25px rgba(0,0,0,0.15); width: 85%; max-width: 340px; animation: slideUp 0.4s ease-out; }
        .modal-window h3 { margin-top: 0; text-align: center; color: var(--primary-color); }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        #edit-group-member-modal, #create-member-for-group-modal {
            z-index: 102; 
        }
        #edit-group-member-modal .avatar-preview,
        #create-member-for-group-modal .avatar-preview {
            width: 80px;
            height: 80px;
        }

        .context-menu { position: fixed; z-index: 1000; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.15); overflow: hidden; padding: 5px 0; animation: fadeIn 0.1s ease; }
        .context-menu-item { padding: 10px 20px; cursor: pointer; }
        .context-menu-item:hover { background-color: #f5f5f5; }
        .context-menu-item.danger { color: #e53935; }
        
        .action-sheet-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.4); z-index: 200; 
            display: none; align-items: flex-end; 
            animation: fadeIn 0.3s ease;
        }
        .action-sheet-overlay.visible { display: flex; }
        .action-sheet {
            background: #f7f7f7; width: 100%; 
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding: 10px; padding-bottom: calc(10px + env(safe-area-inset-bottom));
            animation: slideUp 0.3s ease-out;
        }
        .action-sheet-button {
            width: 100%; background: white; border: none; padding: 15px; 
            font-size: 16px; color: var(--primary-color); font-weight: 500;
            cursor: pointer; border-radius: 10px; margin-bottom: 8px;
        }
        .action-sheet-button.danger { color: #e53935; }
        .action-sheet-button:last-child { margin-bottom: 0; }

        #chat-list-screen .content, #world-book-screen .content { padding: 10px 0 0 0; }
        .list-container { list-style: none; margin: 0; padding: 0; }
        .list-item { display: flex; align-items: center; padding: 10px 20px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background-color 0.2s ease; position: relative; }
        .list-item:hover { background-color: #fdf6f8; }
        .chat-item.pinned { background-color: var(--top-pinned-bg); }
        .chat-avatar { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; object-fit: cover; flex-shrink: 0; background-color: #eee; }
        .group-avatar { border-radius: 10px; }
        .item-details { flex-grow: 1; overflow: hidden; }
        .item-details-row { display: flex; justify-content: space-between; align-items: center; }
        .item-name { font-weight: 600; color: var(--text-color); font-size: 16px; }
        .item-preview-wrapper { display: flex; align-items: center; gap: 8px; margin-top: 4px; }
        .item-preview { font-size: 14px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; }
        .pin-badge {
            background-color: var(--primary-color); color: white;
            font-size: 10px; font-weight: bold;
            padding: 2px 6px; border-radius: 5px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        #chat-room-screen { background-size: cover; background-position: center; }
        #chat-room-screen .content {
            display: flex; flex-direction: column; padding: 10px;
            padding-bottom: 10px;
            transition: padding-bottom 0.3s ease;
        }
        #chat-room-screen.multi-select-active .content {
            padding-bottom: 70px; 
        }
        .message-area { flex-grow: 1; overflow-y: auto; padding: 0 10px; scroll-behavior: smooth; }
        .message-wrapper { display: flex; margin-bottom: 12px; align-items: flex-start; transition: background-color 0.2s; flex-direction: column; }
        .message-wrapper.group-message { margin-bottom: 18px; }
        .message-wrapper.sent { align-items: flex-end; }
        .message-wrapper.received { align-items: flex-start; }
        .message-wrapper.system-notification { align-items: center; }
        .message-bubble-row { display: flex; width: 100%; align-items: flex-start; }
        .message-wrapper.sent .message-bubble-row { flex-direction: row-reverse; }
        .message-wrapper.multi-select-selected { background-color: rgba(144, 202, 249, 0.2); border-radius: var(--border-radius); }
        
        .message-info { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            position: relative;
        }
        .group-nickname {
            position: absolute;
            top: -15px;
            font-size: 11px;
            color: #888;
            white-space: nowrap;
            width: 70px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .message-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
        .message-time { font-size: 9px; color: #aaa; margin-top: 3px; }
        .message-bubble { max-width: 200px; padding: 8px 12px; border-radius: var(--border-radius); word-wrap: break-word; line-height: 1.4; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); margin: 0 8px; cursor: pointer; font-size: 15px; }
        .message-bubble.sent { border-bottom-right-radius: 5px; }
        .message-bubble.received { border-bottom-left-radius: 5px; }
        
        /* New Style for Blocked Message Indicator */
        .blocked-indicator {
            width: 16px;
            height: 16px;
            background-color: #ef5350; /* Red color */
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
            margin: auto 6px;
        }
        .message-wrapper.sent .blocked-indicator {
             /* Placed before the bubble row for sent messages */
            order: -1;
        }
         .message-wrapper.received .message-bubble-row {
            align-items: center; /* Align items to center for indicator */
        }

        .system-notification-bubble {
            background-color: rgba(200, 200, 200, 0.5);
            color: #666;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 10px;
            text-align: center;
        }

        .image-bubble { max-width: 120px; border-radius: var(--border-radius); margin: 0 8px; padding: 4px; background-color: rgba(255, 255, 255, 0.5); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; }
        .image-bubble img { width: 100%; height: auto; display: block; border-radius: calc(var(--border-radius) - 4px); }
        .message-wrapper.sent .image-bubble { border-bottom-right-radius: 5px; }
        .message-wrapper.received .image-bubble { border-bottom-left-radius: 5px; }

        .voice-bubble { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; border-radius: var(--border-radius); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); margin: 0 8px; cursor: pointer; transition: all 0.2s ease; min-width: 90px; max-width: 200px; }
        .message-wrapper.sent .voice-bubble { border-bottom-right-radius: 5px; flex-direction: row-reverse; }
        .message-wrapper.received .voice-bubble { border-bottom-left-radius: 5px; }
        .voice-bubble .play-icon { width: 18px; height: 18px; flex-shrink: 0; }
        .voice-bubble .duration { font-size: 13px; margin: 0 8px; white-space: nowrap; }
        .message-wrapper.sent .play-icon { transform: scaleX(-1); }
        .voice-transcript { font-size: 14px; color: #555; background-color: rgba(255,255,255,0.7); padding: 8px 12px; margin-top: 5px; margin-left: 54px; margin-right: 54px; border-radius: 10px; line-height: 1.6; max-width: calc(100% - 108px); display: none; animation: fadeIn 0.3s ease; }
        .voice-transcript.active { display: block; }
        .message-wrapper.sent .voice-transcript { align-self: flex-end; margin-right: 54px; margin-left: auto; }
        .message-wrapper.received .voice-transcript { align-self: flex-start; margin-left: 54px; margin-right: auto; }

        .pv-card {
            width: 230px; 
            aspect-ratio: 1 / 1;
            background-color: #f0f0f0;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
            cursor: pointer;
            margin: 0 8px;
        }
        .message-wrapper.sent .pv-card { border-bottom-right-radius: 5px; }
        .message-wrapper.received .pv-card { border-bottom-left-radius: 5px; }

        .pv-card-image-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            transition: opacity 0.5s ease-in-out;
            z-index: 2;
        }
        .pv-card-image-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .pv-card-content {
            padding: 15px;
            height: 100%;
            overflow-y: auto;
            color: var(--text-color);
            line-height: 1.6;
            font-size: 15px;
            background-color: white;
            position: relative;
            z-index: 1;
        }
        .pv-card-footer {
            background: linear-gradient(to top, rgba(0,0,0,0.6), transparent);
            color: white;
            padding: 20px 10px 8px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 3;
            pointer-events: none; 
            transition: opacity 0.5s ease-in-out;
        }
        .pv-card-footer.hidden {
            opacity: 0;
        }
        .pv-card-footer svg {
            width: 14px;
            height: 14px;
            fill: white;
            flex-shrink: 0;
        }

        .transfer-card {
            width: 240px;
            height: auto;
            border-radius: var(--border-radius);
            margin: 0 8px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            color: white;
        }
        .message-wrapper.sent .transfer-card { border-bottom-right-radius: 5px; }
        .message-wrapper.received .transfer-card { 
            border-bottom-left-radius: 5px; 
            cursor: pointer;
        }
        .transfer-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-size: cover;
            background-position: center;
            filter: blur(4px);
            transform: scale(1.1);
            z-index: 1;
        }
        .transfer-card.sent-transfer::before {
            background-image: url('https://i.postimg.cc/sxN893WF/IMG-20250712.png');
        }
        .transfer-card.received-transfer::before {
            background-image: url('https://i.postimg.cc/FzR8LY7g/IMG-20250712-170703.png');
        }

        .transfer-card .overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.3);
            z-index: 2;
            transition: background-color 0.5s ease;
        }
        .transfer-card.received .overlay { background-color: rgba(255, 182, 193, 0.4); }
        .transfer-card.returned .overlay { background-color: rgba(100, 100, 100, 0.5); }
        
        .transfer-content {
            position: relative;
            z-index: 3;
            padding: 20px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        .transfer-title {
            font-size: 14px;
            margin: 0 0 5px 0;
            opacity: 0.9;
        }
        .transfer-amount {
            font-size: 28px;
            font-weight: bold;
            margin: 0;
        }
        .transfer-remark {
            font-size: 14px;
            margin-top: 10px;
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .transfer-status {
            font-size: 12px;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            opacity: 0.8;
        }

        .gift-card {
            width: 230px;
            background-color: #fff;
            border: 2px solid #333;
            border-radius: var(--border-radius);
            box-shadow: 4px 4px 0px #ddd;
            padding: 10px;
            display: flex;
            align-items: center;
            cursor: pointer;
            margin: 0 8px;
            position: relative;
            overflow: hidden;
        }
        .message-wrapper.sent .gift-card { border-bottom-right-radius: 5px; }
        .message-wrapper.received .gift-card { border-bottom-left-radius: 5px; }
        .gift-card-icon {
            width: 50px;
            height: 50px;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .gift-card-text {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            font-family: 'Comic Sans MS', 'Chalkduster', 'Handwriting', cursive;
        }
        .gift-card-description { 
            font-size: 14px; color: #555; background-color: rgba(240,240,240,0.9); 
            padding: 8px 12px; margin-top: 5px; margin-left: 54px; margin-right: 54px; 
            border-radius: 10px; line-height: 1.6; max-width: calc(100% - 108px); 
            display: none; animation: fadeIn 0.3s ease;
        }
        .gift-card-description.active { display: block; }
        .message-wrapper.sent .gift-card-description { align-self: flex-end; margin-right: 54px; margin-left: auto; }
        .message-wrapper.received .gift-card-description { align-self: flex-start; margin-left: 54px; margin-right: auto; }
        
        .gift-card-received-stamp {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 14px;
            font-weight: bold;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 2px 6px;
            transform: rotate(15deg);
            opacity: 0;
            transition: opacity 0.3s ease;
            font-family: 'Comic Sans MS', 'Chalkduster', 'Handwriting', cursive;
        }
        .gift-card.received .gift-card-received-stamp {
            opacity: 1;
        }


        .load-more-btn { background-color: #e0e0e0; color: #757575; border: none; padding: 8px 16px; margin: 10px auto; border-radius: 15px; cursor: pointer; display: block; font-size: 13px; font-weight: 500; }
        .load-more-btn:hover { background-color: #d1d1d1; }
        .typing-indicator { text-align: center; color: #aaa; font-style: italic; font-size: 14px; padding: 10px 0; display: none; }
        
        #sticker-bar { flex-shrink: 0; padding: 0 10px 5px; display: flex; align-items: center; background: rgba(255,255,255,0.7); backdrop-filter: blur(10px); }
        .sticker-bar-btn { background: none; border: none; padding: 5px; cursor: pointer; }
        .sticker-bar-btn svg { width: 28px; height: 28px; fill: #888; }
        #sticker-modal { position: absolute; bottom: 0; left: 0; right: 0; height: 35%; max-height: 250px; background: #f7f7f7; border-top-left-radius: 20px; border-top-right-radius: 20px; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); z-index: 25; display: none; flex-direction: column; }
        #sticker-modal.visible { display: flex; animation: slideUp 0.3s ease-out; }
        #sticker-modal .header { padding: 10px 15px; font-weight: bold; color: var(--text-color); border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;}
        .sticker-grid { flex-grow: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 15px; }
        .sticker-item { position: relative; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .sticker-item img { width: 60px; height: 60px; object-fit: contain; }
        .sticker-item span { font-size: 12px; color: #666; margin-top: 5px; text-align: center; }
        #add-sticker-modal .modal-window { max-width: 360px; }
        #sticker-preview { width: 100px; height: 100px; border: 2px dashed #ddd; border-radius: 10px; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; color: #aaa; background-color: #f9f9f9; }
        #sticker-preview img { max-width: 100%; max-height: 100%; }

        .chat-input-wrapper { flex-shrink: 0; }
        .message-input-area { display: flex; align-items: center; padding: 10px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); border-top: 1px solid #eee; background: rgba(255,255,255,0.7); backdrop-filter: blur(10px); flex-shrink: 0; gap: 10px; border-bottom-left-radius: var(--phone-corner-radius); border-bottom-right-radius: var(--phone-corner-radius); overflow: hidden; }
        .message-input-area input { flex-grow: 1; border: none; padding: 12px; border-radius: 18px; background-color: #f0f0f0; }
        .message-input-area input:focus { outline: none; }
        .message-input-area .icon-btn { background: var(--primary-color); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
        .message-input-area .icon-btn:disabled { background-color: #cccccc; cursor: not-allowed; }
        .message-input-area .icon-btn svg { width: 20px; height: 20px; fill: currentColor; }
        .message-input-area .icon-btn.send-btn { font-size: 18px; }

        #multi-select-bar { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); display: none; justify-content: space-between; align-items: center; padding: 10px 20px; padding-bottom: calc(10px + env(safe-area-inset-bottom)); border-top: 1px solid #eee; z-index: 20; border-bottom-left-radius: var(--phone-corner-radius); border-bottom-right-radius: var(--phone-corner-radius); animation: slideUp 0.3s ease-out; }
        #multi-select-bar.visible { display: flex; }
        
        .settings-sidebar { position: absolute; top: 0; right: -100%; width: 80%; height: 100%; background: #fff; box-shadow: -5px 0 15px rgba(0,0,0,0.1); transition: right 0.4s ease-in-out; z-index: 101; display: flex; flex-direction: column; }
        .settings-sidebar.open { right: 0; }
        .settings-sidebar .header { padding: 15px; border-bottom: 1px solid #eee; font-weight: bold; text-align: center; color: var(--primary-color); }
        .settings-sidebar .content { padding: 20px; overflow-y: auto; flex-grow: 1; }
        .settings-sidebar .form-group textarea { height: 100px; resize: vertical; }
        .settings-sidebar .avatar-setting { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .settings-sidebar .avatar-preview { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); cursor: pointer; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--secondary-color); font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #fce4ec; border-radius: 10px; background-color: #fff; transition: border-color 0.3s; font-family: var(--font-family); font-size: 14px; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary-color); }
        .form-group.radio-group { display: flex; gap: 20px; align-items: center; }
        .form-group.radio-group label { margin-bottom: 0; }
        
        .btn { width: 100%; padding: 15px; border-radius: 10px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; text-align: center; }
        .btn-primary { background-color: var(--primary-color); color: var(--white-color); }
        .btn-primary:hover { background-color: var(--secondary-color); box-shadow: 0 4px 15px rgba(255, 128, 171, 0.5); }
        label.btn-primary { color: var(--white-color) !important; }
        .btn-small { padding: 8px 16px; font-size: 14px; width: auto; }
        .btn-secondary { background-color: var(--accent-color); color: var(--white-color); margin-bottom: 15px; }
        .btn-secondary:hover { background-color: #64b5f6; box-shadow: 0 4px 15px rgba(144, 202, 249, 0.5); }
        .btn-neutral { background-color: #bdbdbd; color: var(--white-color); }
        .btn-neutral:hover { background-color: #9e9e9e; }
        .btn-danger { background-color: #ef5350; color: white; }
        .btn .spinner { display: none; width: 16px; height: 16px; border: 2px solid rgba(255, 255, 255, 0.5); border-top-color: var(--white-color); border-radius: 50%; animation: spin 1s linear infinite; }
        .btn.loading .spinner { display: block; }
        .btn.loading .btn-text { display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .wallpaper-preview { width: 100%; aspect-ratio: 9 / 16; max-height: 400px; border-radius: var(--border-radius); margin-bottom: 25px; background-size: cover; background-position: center; border: 3px dashed var(--primary-color); display: flex; align-items: center; justify-content: center; color: var(--secondary-color); font-style: italic; background-color: #fff8fa; }
        .toast { position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.7); color: white; padding: 10px 20px; border-radius: 15px; font-size: 14px; opacity: 0; visibility: hidden; transition: opacity 0.5s, visibility 0.5s; z-index: 1000; }
        .toast.show { opacity: 1; visibility: visible; }

        #world-book-selection-modal, #invite-member-modal {
            z-index: 102;
        }
        #world-book-selection-modal .modal-window, 
        #invite-member-modal .modal-window {
            width: 90%;
            max-width: 380px;
        }
        #world-book-selection-list, #invite-member-selection-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 40vh;
            overflow-y: auto;
        }
        .world-book-select-item, .invite-member-select-item {
            display: flex;
            align-items: center;
            padding: 12px 5px;
            border-bottom: 1px solid #f0f0f0;
        }
        .world-book-select-item:last-child, .invite-member-select-item:last-child {
            border-bottom: none;
        }
        .world-book-select-item input[type="checkbox"],
        .invite-member-select-item input[type="checkbox"] {
            margin-right: 15px;
            width: 20px;
            height: 20px;
        }
        .world-book-select-item label, .invite-member-select-item label {
            font-weight: 500;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .invite-member-select-item img {
            width: 40px; height: 40px; border-radius: 50%; object-fit: cover;
        }

        /* --- Group Chat Specific Styles --- */
        .member-selection-list {
            list-style: none;
            padding: 0;
            margin: 15px 0;
            max-height: 40vh;
            overflow-y: auto;
        }
        .member-selection-item {
            display: flex;
            align-items: center;
            padding: 10px 5px;
            border-bottom: 1px solid #f0f0f0;
        }
        .member-selection-item:last-child { border-bottom: none; }
        .member-selection-item input[type="checkbox"] { margin-right: 15px; width: 20px; height: 20px; flex-shrink: 0; }
        .member-selection-item img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px; }
        .member-selection-item label { font-weight: 500; color: var(--text-color); }

        #group-settings-sidebar .group-avatar-setting {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        #group-settings-sidebar .group-avatar-preview {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            object-fit: cover;
            border: 2px solid var(--primary-color);
            cursor: pointer;
        }

        #group-settings-sidebar .group-members-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        #group-settings-sidebar .group-member,
        #group-settings-sidebar .add-member-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }
        #group-settings-sidebar .group-member img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 5px;
            border: 2px solid #eee;
        }
        #group-settings-sidebar .add-member-btn .add-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #ccc;
            margin-bottom: 5px;
            transition: all 0.2s ease;
        }
        #group-settings-sidebar .add-member-btn:hover .add-icon {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        #group-settings-sidebar .group-member span,
        #group-settings-sidebar .add-member-btn span {
            font-size: 12px;
            text-align: center;
            color: var(--text-color);
        }

        #customize-screen .icon-custom-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        #customize-screen .icon-custom-item:last-child {
            border-bottom: none;
        }
        #customize-screen .icon-preview {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            object-fit: cover;
            flex-shrink: 0;
        }
        #customize-screen .icon-details {
            flex-grow: 1;
        }
        #customize-screen .icon-details p {
            margin: 0 0 8px 0;
            font-weight: 600;
        }
        #customize-screen .icon-details input {
            width: calc(100% - 70px);
        }
        #customize-screen .reset-icon-btn {
            background: #e0e0e0;
            color: #555;
            border: none;
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        /* --- Tutorial Screen Styles --- */
        .tutorial-item {
            margin-bottom: 15px;
            border: 1px solid #fce4ec;
            border-radius: 12px;
            overflow: hidden;
            background-color: #fff8fa;
        }
        .tutorial-header {
            padding: 12px 18px;
            font-weight: 600;
            color: var(--secondary-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tutorial-header::after {
            content: '▼';
            font-size: 12px;
            transition: transform 0.3s ease;
        }
        .tutorial-item.open .tutorial-header::after {
            transform: rotate(180deg);
        }
        .tutorial-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease;
            padding: 0 10px;
        }
        .tutorial-item.open .tutorial-content {
            padding: 10px 10px;
            /* A large value to ensure it expands to fit the content */
            max-height: 5000px; 
        }
        .tutorial-content img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
        }

    </style>
</head>
<body>
    <div class="phone-screen">
        <div id="home-screen" class="screen active"></div>
        <div id="chat-list-screen" class="screen">
            <header class="app-header">
                <button class="back-btn" data-target="home-screen">‹</button>
                <div class="title-container"><h1 class="title">聊天</h1></div>
                <div class="action-btn-group">
                    <button class="action-btn" id="create-group-btn">群聊</button>
                    <button class="action-btn" id="add-chat-btn">+</button>
                </div>
            </header>
            <main class="content"><ul class="list-container" id="chat-list-container"></ul><div class="placeholder-text" id="no-chats-placeholder" style="display: none;"><p>还没有聊天对象哦~</p><p>点击右上角的“+”创建一个吧！</p></div></main>
        </div>
        <div id="chat-room-screen" class="screen">
            <header class="app-header" id="chat-room-header-default">
                <button class="back-btn" data-target="chat-list-screen">‹</button>
                <div class="title-container">
                    <h1 class="title" id="chat-room-title">...</h1>
                    <div class="subtitle" id="chat-room-subtitle"><div class="online-indicator"></div><span id="chat-room-status-text">在线</span></div>
                </div>
                <button class="action-btn" id="chat-settings-btn"><img src="https://i.postimg.cc/nhwP4pQy/chan-73.png" alt="设置"></button>
            </header>
            <header class="app-header" id="chat-room-header-select" style="display: none;">
                <button class="action-btn" id="cancel-multi-select-btn">取消</button>
                <div class="title-container"><h1 class="title" id="multi-select-title">选择消息</h1></div>
                <div class="placeholder"></div>
            </header>
            <main class="content">
                <div class="message-area" id="message-area"></div>
                <div class="typing-indicator" id="typing-indicator"></div>
            </main>
            <div class="chat-input-wrapper">
                <div id="sticker-bar">
                    <button class="sticker-bar-btn" id="sticker-toggle-btn"><svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg></button>
                    <button class="sticker-bar-btn" id="photo-video-btn"><svg viewBox="0 0 24 24"><path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z" /></svg></button>
                    <button class="sticker-bar-btn" id="voice-message-btn"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/></svg></button>
                    <button class="sticker-bar-btn" id="wallet-btn"><svg viewBox="0 0 24 24"><path d="M20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4ZM20 18H4V8H20V18ZM4 6H20V6H4Z"/></svg></button>
                    <button class="sticker-bar-btn" id="gift-btn"><svg viewBox="0 0 24 24"><path d="M20,8L12,13L4,8V6H20M20,4H4A2,2 0 0,0 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6A2,2 0 0,0 20,4M12.5,18C12.5,17.29 12.17,16.65 11.64,16.27C12.17,15.89 12.5,15.26 12.5,14.55C12.5,13.6 11.83,12.79 11,12.58V12H13V10H11V8H13V6H11V5C11,4.45 10.55,4 10,4H8C7.45,4 7,4.45 7,5V6H9V8H7V10H9V12H7V12.58C6.17,12.79 5.5,13.6 5.5,14.55C5.5,15.26 5.83,15.89 6.36,16.27C5.83,16.65 5.5,17.29 5.5,18H12.5Z"/></svg></button>
                </div>
                <div class="message-input-area" id="message-input-default">
                    <input type="text" id="message-input" placeholder="输入消息..."><button id="send-message-btn" class="icon-btn send-btn">➤</button>
                    <button id="get-reply-btn" class="icon-btn"><svg viewBox="0 0 24 24"><path d="M12,2A10,10 0 1,0 22,12A10,10 0 0,0 12,2M12,20A8,8 0 1,1 20,12A8,8 0 0,1 12,20M16.24,7.76C15.07,6.58 13.53,6 12,6V12L7.76,16.24C10.1,18.58 13.9,18.58 16.24,16.24C18.58,13.9 18.58,10.1 16.24,7.76Z" /></svg></button>
                </div>
                <div class="message-input-area" id="message-edit-bar" style="display: none;">
                    <input type="text" id="message-edit-input"><button id="save-edit-btn" class="icon-btn send-btn">✓</button><button id="cancel-edit-btn" class="icon-btn" style="background-color: #aaa;">✗</button>
                </div>
            </div>
            <div id="multi-select-bar"><span id="select-count">已选择 0 项</span><button class="btn btn-danger" id="delete-selected-btn" style="width: auto; padding: 8px 16px;">删除已选</button></div>
            <div id="sticker-modal"><div class="header"><span>我的表情</span><button class="btn btn-primary btn-small" id="add-new-sticker-btn">添加新表情</button></div><div class="sticker-grid" id="sticker-grid-container"></div></div>
        </div>
        <div id="world-book-screen" class="screen">
            <header class="app-header">
                <button class="back-btn" data-target="home-screen">‹</button>
                <div class="title-container"><h1 class="title">世界书</h1></div>
                <button class="action-btn" id="add-world-book-btn">+</button>
            </header>
            <main class="content">
                <ul class="list-container" id="world-book-list-container"></ul>
                <div class="placeholder-text" id="no-world-books-placeholder" style="display: none;">
                    <p>你的世界一片混沌...</p><p>点击右上角的“+”创造第一个设定吧！</p>
                </div>
            </main>
        </div>
        <div id="edit-world-book-screen" class="screen">
            <header class="app-header">
                <button class="back-btn" data-target="world-book-screen">‹</button>
                <div class="title-container"><h1 class="title" id="edit-world-book-title">创建/编辑条目</h1></div>
                <div class="placeholder"></div>
            </header>
            <main class="content">
                <form id="edit-world-book-form">
                    <input type="hidden" id="world-book-id">
                    <div class="form-group">
                        <label for="world-book-name">条目名称</label>
                        <input type="text" id="world-book-name" placeholder="例如：世界观背景、魔法体系" required>
                    </div>
                    <div class="form-group">
                        <label for="world-book-content">条目内容</label>
                        <textarea id="world-book-content" rows="8" placeholder="详细描述此项设定..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label>注入位置</label>
                        <div class="form-group radio-group">
                            <label><input type="radio" name="world-book-position" value="before" checked> 前</label>
                            <label><input type="radio" name="world-book-position" value="after"> 后</label>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">保存条目</button>
                </form>
            </main>
        </div>
        <div id="api-settings-screen" class="screen"></div>
        <div id="wallpaper-screen" class="screen"></div>
        <div id="font-settings-screen" class="screen"></div>
        <div id="customize-screen" class="screen"></div>
        <div id="tutorial-screen" class="screen"></div>
        <div id="toast-notification" class="toast"></div>
        <div id="add-char-modal" class="modal-overlay"><div class="modal-window"><h3>创建新角色</h3><form id="add-char-form"><div class="form-group"><label for="char-real-name">角色姓名</label><input type="text" id="char-real-name" placeholder="角色的真实姓名" required></div><div class="form-group"><label for="char-remark-name">角色备注 (昵称)</label><input type="text" id="char-remark-name" placeholder="你对Ta的称呼" required></div><div class="form-group"><label for="my-name-for-char">我的姓名</label><input type="text" id="my-name-for-char" placeholder="你希望Ta如何称呼你" required></div><button type="submit" class="btn btn-primary">创建</button></form></div></div>
        <div id="add-sticker-modal" class="modal-overlay"><div class="modal-window"><h3 id="add-sticker-modal-title">添加新表情</h3><form id="add-sticker-form"><input type="hidden" id="sticker-edit-id"><div id="sticker-preview"><span>预览</span></div><div class="form-group"><label for="sticker-name">表情名称</label><input type="text" id="sticker-name" placeholder="如：开心" required></div><div class="form-group"><label for="sticker-url-input">表情URL</label><input type="url" id="sticker-url-input" placeholder="粘贴图片URL"></div><p style="text-align:center; color:#888; margin: -10px 0 15px;">或</p><input type="file" id="sticker-file-upload" accept="image/*" style="display:none;"><label for="sticker-file-upload" class="btn btn-secondary" style="width:100%; margin-bottom: 20px;">从本地上传</label><button type="submit" class="btn btn-primary">保存</button></form></div></div>
        <div id="sticker-actionsheet" class="action-sheet-overlay"><div class="action-sheet"><button class="action-sheet-button" id="edit-sticker-btn">编辑</button><button class="action-sheet-button danger" id="delete-sticker-btn">删除</button></div></div>
        <div id="send-voice-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>发送语音消息</h3>
                <form id="send-voice-form">
                    <div class="form-group">
                        <label for="voice-text-input">输入语音文字</label>
                        <textarea id="voice-text-input" placeholder="在这里输入你想说的话..." required rows="4"></textarea>
                    </div>
                    <div class="form-group" style="text-align:center; color:#888; font-size: 14px;">
                        预计时长: <span id="voice-duration-preview">0"</span>
                    </div>
                    <button type="submit" class="btn btn-primary">发送</button>
                </form>
            </div>
        </div>
        <div id="send-pv-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>分享照片/视频</h3>
                <form id="send-pv-form">
                    <div class="form-group">
                        <label for="pv-text-input">输入描述</label>
                        <textarea id="pv-text-input" placeholder="在这里描述你的照片或视频内容..." required rows="4"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">发送</button>
                </form>
            </div>
        </div>
        <div id="send-transfer-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>转账</h3>
                <form id="send-transfer-form">
                    <div class="form-group">
                        <label for="transfer-amount-input">金额 (元)</label>
                        <input type="number" id="transfer-amount-input" placeholder="0.00" required step="0.01" min="0.01">
                    </div>
                     <div class="form-group">
                        <label for="transfer-remark-input">备注</label>
                        <input type="text" id="transfer-remark-input" placeholder="（选填）">
                    </div>
                    <button type="submit" class="btn btn-primary">发送</button>
                </form>
            </div>
        </div>
        <div id="send-gift-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>送出礼物</h3>
                <form id="send-gift-form">
                    <div class="form-group">
                        <label for="gift-description-input">礼物描述</label>
                        <textarea id="gift-description-input" placeholder="告诉Ta你送了什么特别的东西..." required rows="4"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">发送</button>
                </form>
            </div>
        </div>
        <div id="receive-transfer-actionsheet" class="action-sheet-overlay">
            <div class="action-sheet">
                <button class="action-sheet-button" id="accept-transfer-btn">接收</button>
                <button class="action-sheet-button danger" id="return-transfer-btn">退回</button>
            </div>
        </div>
        <!-- Private Chat Settings -->
        <div id="chat-settings-sidebar" class="settings-sidebar"><div class="header">聊天设置</div><div class="content"><form id="chat-settings-form"><div class="avatar-setting"><img src="" alt="角色头像" id="setting-char-avatar-preview" class="avatar-preview"><input type="file" id="setting-char-avatar-upload" accept="image/*" style="display:none;"><label for="setting-char-avatar-upload" class="btn btn-primary" style="flex-grow:1;">更换角色头像</label></div><div class="form-group"><label for="setting-char-remark">角色备注 (昵称)</label><input type="text" id="setting-char-remark"></div><div class="form-group"><label for="setting-char-persona">角色人设</label><textarea id="setting-char-persona" placeholder="详细描述角色的性格、背景、说话风格等。"></textarea></div><hr style="border:none; border-top:1px solid #eee; margin: 20px 0;"><div class="avatar-setting"><img src="" alt="我的头像" id="setting-my-avatar-preview" class="avatar-preview"><input type="file" id="setting-my-avatar-upload" accept="image/*" style="display:none;"><label for="setting-my-avatar-upload" class="btn btn-secondary" style="flex-grow:1;">更换我的头像</label></div><div class="form-group"><label for="setting-my-name">我的姓名</label><input type="text" id="setting-my-name"></div><div class="form-group"><label for="setting-my-persona">我的人设</label><textarea id="setting-my-persona" placeholder="描述你希望在对话中扮演的形象。"></textarea></div><hr style="border:none; border-top:1px solid #eee; margin: 20px 0;"><div class="form-group"><button type="button" class="btn btn-secondary" id="link-world-book-btn">关联世界书</button></div><div class="form-group"><label for="setting-theme-color">主题颜色 (对方/我方)</label><select id="setting-theme-color"></select></div><div class="form-group"><label for="setting-max-memory">最大记忆轮数</label><input type="number" id="setting-max-memory" value="10" min="1"></div><div class="form-group"><label for="setting-chat-bg-upload" class="btn btn-primary">更换聊天背景</label><input type="file" id="setting-chat-bg-upload" accept="image/*" style="display:none;"></div><button type="submit" class="btn btn-primary">保存设置</button></form><hr style="border:none; border-top:1px solid #eee; margin: 20px 0;"><button type="button" class="btn btn-danger" id="block-contact-btn">拉黑</button><hr style="border:none; border-top:1px solid #eee; margin: 20px 0;"><button type="button" class="
btn btn-danger" id="clear-chat-history-btn">清空聊天记录</button></div></div>
        <div id="world-book-selection-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>选择要关联的世界书</h3>
                <ul id="world-book-selection-list"></ul>
                <button class="btn btn-primary" id="save-world-book-selection-btn" style="margin-top: 20px;">确认</button>
            </div>
        </div>
        <!-- Group Chat Creation Modal -->
        <div id="create-group-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>创建群聊</h3>
                <form id="create-group-form">
                    <div class="form-group">
                        <label>选择群成员</label>
                        <ul id="member-selection-list" class="member-selection-list"></ul>
                    </div>
                    <div class="form-group">
                        <label for="group-name-input">群聊名称</label>
                        <input type="text" id="group-name-input" placeholder="给你的群聊起个名字吧" required>
                    </div>
                    <button type="submit" class="btn btn-primary">创建群聊</button>
                </form>
            </div>
        </div>
        <!-- Group Chat Settings -->
        <div id="group-settings-sidebar" class="settings-sidebar">
            <div class="header">群聊设置</div>
            <div class="content">
                <form id="group-settings-form">
                    <div class="group-avatar-setting">
                        <img src="" alt="群头像" id="setting-group-avatar-preview" class="group-avatar-preview">
                        <input type="file" id="setting-group-avatar-upload" accept="image/*" style="display:none;">
                        <label for="setting-group-avatar-upload" class="btn btn-primary" style="flex-grow:1;">更换群头像</label>
                    </div>
                    <div class="form-group">
                        <label for="setting-group-name">群名 (AI也可见)</label>
                        <input type="text" id="setting-group-name">
                    </div>
                    <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                    <div class="avatar-setting">
                        <img src="" alt="我的头像" id="setting-group-my-avatar-preview" class="avatar-preview">
                        <input type="file" id="setting-group-my-avatar-upload" accept="image/*" style="display:none;">
                        <label for="setting-group-my-avatar-upload" class="btn btn-secondary" style="flex-grow:1;">更换我的头像</label>
                    </div>
                    <div class="form-group">
                        <label for="setting-group-my-nickname">我的群昵称</label>
                        <input type="text" id="setting-group-my-nickname">
                    </div>
                    <div class="form-group">
                        <label for="setting-group-my-persona">我的人设</label>
                        <textarea id="setting-group-my-persona" placeholder="描述你希望在此群聊中扮演的形象。"></textarea>
                    </div>
                    <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                    <div class="form-group">
                        <label>群成员</label>
                        <div class="group-members-list" id="group-members-list-container"></div>
                    </div>
                     <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                    <div class="form-group"><label for="setting-group-theme-color">主题颜色 (对方/我方)</label><select id="setting-group-theme-color"></select></div>
                    <div class="form-group"><label for="setting-group-max-memory">最大记忆轮数</label><input type="number" id="setting-group-max-memory" value="10" min="1"></div>
                    <div class="form-group"><label for="setting-group-chat-bg-upload" class="btn btn-primary">更换聊天背景</label><input type="file" id="setting-group-chat-bg-upload" accept="image/*" style="display:none;"></div>
                    <button type="submit" class="btn btn-primary">保存设置</button>
                </form>
                <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                <button type="button" class="btn btn-danger" id="clear-group-chat-history-btn">清空聊天记录</button>
            </div>
        </div>
        <!-- Group Member Edit Modal -->
        <div id="edit-group-member-modal" class="modal-overlay">
            <div class="modal-window">
                <h3 id="edit-group-member-title">编辑群成员</h3>
                <form id="edit-group-member-form">
                    <input type="hidden" id="editing-member-id">
                    <div class="avatar-setting" style="justify-content: center;">
                        <img src="" alt="成员头像" id="edit-member-avatar-preview" class="avatar-preview" style="cursor: pointer;">
                        <input type="file" id="edit-member-avatar-upload" accept="image/*" style="display:none;">
                    </div>
                    <div class="form-group">
                        <label for="edit-member-group-nickname">群昵称</label>
                        <input type="text" id="edit-member-group-nickname" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-member-real-name">真名</label>
                        <input type="text" id="edit-member-real-name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-member-persona">人设</label>
                        <textarea id="edit-member-persona" placeholder="详细描述角色的性格、背景等。"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">保存</button>
                </form>
            </div>
        </div>
        <!-- Add Member to Group Action Sheet -->
        <div id="add-member-actionsheet" class="action-sheet-overlay">
            <div class="action-sheet">
                <button class="action-sheet-button" id="invite-existing-member-btn">邀请现有角色</button>
                <button class="action-sheet-button" id="create-new-member-btn">创建新角色入群</button>
            </div>
        </div>
        <!-- Invite Existing Member Modal -->
        <div id="invite-member-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>邀请成员加入群聊</h3>
                <ul id="invite-member-selection-list"></ul>
                <button class="btn btn-primary" id="confirm-invite-btn" style="margin-top: 20px;">确认邀请</button>
            </div>
        </div>
        <!-- Create New Member for Group Modal -->
        <div id="create-member-for-group-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>创建新角色并加入群聊</h3>
                <form id="create-member-for-group-form">
                    <div class="avatar-setting" style="justify-content: center;">
                        <img src="https://i.postimg.cc/Y96LPskq/o-o-2.jpg" alt="新成员头像" id="create-group-member-avatar-preview" class="avatar-preview" style="cursor: pointer;">
                        <input type="file" id="create-group-member-avatar-upload" accept="image/*" style="display:none;">
                    </div>
                    <div class="form-group">
                        <label for="create-group-member-nickname">群昵称</label>
                        <input type="text" id="create-group-member-nickname" required>
                    </div>
                    <div class="form-group">
                        <label for="create-group-member-realname">真名</label>
                        <input type="text" id="create-group-member-realname" required>
                    </div>
                    <div class="form-group">
                        <label for="create-group-member-persona">人设</label>
                        <textarea id="create-group-member-persona" placeholder="详细描述角色的性格、背景等。"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">创建并加入</button>
                </form>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
// 在 <script> 标签内，DOMContentLoaded 事件监听器的顶部添加此函数

async function compressImage(file, options = {}) {
    // 默认压缩选项
    const { quality = 0.8, maxWidth = 800, maxHeight = 800 } = options;

    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onerror = reject;
        reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onerror = reject;
            img.onload = () => {
                let width = img.width;
                let height = img.height;

                // 按比例缩放图片尺寸
                if (width > height) {
                    if (width > maxWidth) {
                        height = Math.round(height * (maxWidth / width));
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width = Math.round(width * (maxHeight / height));
                        height = maxHeight;
                    }
                }

                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');

                // 在Canvas上绘制缩放后的图片
                ctx.drawImage(img, 0, 0, width, height);

                // 将Canvas内容转换为指定质量的JPG格式的Base64字符串
                // JPG格式通常比PNG有更好的压缩率，适合照片类图片
                const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                resolve(compressedDataUrl);
            };
        };
    });
}
    // --- Initial HTML Injection ---
    document.getElementById('api-settings-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">API 设置</h1></div><div class="placeholder"></div></header><main class="content"><form id="api-form"><div class="form-group"><label for="api-provider">API 服务商</label><select id="api-provider" name="provider"><option value="newapi">NewAPI (自定义)</option><option value="deepseek">DeepSeek</option><option value="claude">Claude</option><option value="gemini">Gemini</option></select></div><div class="form-group"><label for="api-url">API 地址（后缀不用添加/v1）</label><input type="url" id="api-url" name="url" placeholder="选择服务商可自动填写" required></div><div class="form-group"><label for="api-key">密钥 (Key)</label><input type="password" id="api-key" name="key" placeholder="请输入你的API密钥" required></div><button type="button" class="btn btn-secondary" id="fetch-models-btn"><span class="btn-text">点击拉取模型</span><div class="spinner"></div></button><div class="form-group"><label for="api-model">选择模型</label><select id="api-model" name="model" required><option value="">请先拉取模型列表</option></select></div><button type="submit" class="btn btn-primary" id="save-btn"><span class="btn-text">保 存</span><div class="spinner"></div></button></form></main>`;
    document.getElementById('wallpaper-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">更换壁纸</h1></div><div class="placeholder"></div></header><main class="content"><div class="wallpaper-preview" id="wallpaper-preview"><span>当前壁纸预览</span></div><input type="file" id="wallpaper-upload" accept="image/*" style="display: none;"><label for="wallpaper-upload" class="btn btn-primary">从相册选择新壁纸</label></main>`;
    document.getElementById('font-settings-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">字体设置</h1></div><div class="placeholder"></div></header><main class="content"><form id="font-settings-form"><div class="form-group"><label for="font-url">字体链接 (ttf, woff, woff2)</label><input type="url" id="font-url" placeholder="https://.../font.ttf" required></div><p style="font-size:12px; color:#888; text-align:center;">示例: https://lf3-static.bytednsdoc.com/obj/eden-cn/jplptk/ljhwZthlaukjlkulzlp/portal/fonts/HarmonyOS_Sans_SC_Regular.woff2</p><button type="submit" class="btn btn-primary">应用字体</button><button type="button" class="btn btn-neutral" id="restore-default-font-btn" style="margin-top: 15px;">恢复默认字体</button></form></main>`;
    document.getElementById('customize-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">主屏幕自定义</h1></div><div class="placeholder"></div></header><main class="content"><form id="customize-form"></form></main>`;
    document.getElementById('tutorial-screen').innerHTML = `<header class="app-header"><button class="back-btn" data-target="home-screen">‹</button><div class="title-container"><h1 class="title">教程</h1></div><div class="placeholder"></div></header><main class="content" id="tutorial-content-area"></main>`;
    
    // --- Global Variables and Constants ---
    const colorThemes = {'white_pink':{name:'白/粉',received:{bg:'rgba(255,255,255,0.9)',text:'#6D6D6D'},sent:{bg:'rgba(255,204,204,0.9)',text:'#A56767'}},'white_blue':{name:'白/蓝',received:{bg:'rgba(255,255,255,0.9)',text:'#6D6D6D'},sent:{bg:'rgba(173,216,230,0.9)',text:'#4A6F8A'}},'white_yellow':{name:'白/黄',received:{bg:'rgba(255,255,255,0.9)',text:'#6D6D6D'},sent:{bg:'rgba(249,237,105,0.9)',text:'#8B7E4B'}},'white_green':{name:'白/绿',received:{bg:'rgba(255,255,255,0.9)',text:'#6D6D6D'},sent:{bg:'rgba(188,238,188,0.9)',text:'#4F784F'}},'white_purple':{name:'白/紫',received:{bg:'rgba(255,255,255,0.9)',text:'#6D6D6D'},sent:{bg:'rgba(185,190,240,0.9)',text:'#6C5B7B'}},'black_red':{name:'黑/红',received:{bg:'rgba(30,30,30,0.85)',text:'#E0E0E0'},sent:{bg:'rgb(226,62,87,0.9)',text:'#fff'}},'black_green':{name:'黑/绿',received:{bg:'rgba(30,30,30,0.85)',text:'#E0E0E0'},sent:{bg:'rgba(119,221,119,0.9)',text:'#2E5C2E'}},'black_white':{name:'黑/白',received:{bg:'rgba(30,30,30,0.85)',text:'#E0E0E0'},sent:{bg:'rgba(245,245,245,0.9)',text:'#333'}},'white_black':{name:'白/黑',received:{bg:'rgba(255,255,255,0.9)',text:'#6D6D6D'},sent:{bg:'rgba(50,50,50,0.85)',text:'#F5F5F5'}},'yellow_purple':{name:'黄/紫',received:{bg:'rgba(255,250,205,0.9)',text:'#8B7E4B'},sent:{bg:'rgba(185,190,240,0.9)',text:'#6C5B7B'}},'pink_blue':{name:'粉/蓝',received:{bg:'rgba(255,231,240,0.9)',text:'#7C6770'},sent:{bg:'rgba(173,216,230,0.9)',text:'#4A6F8A'}},};
    const defaultIcons = {
        'chat-list-screen': { name: '404', url: 'https://i.postimg.cc/VvQB8dQT/chan-143.png' },
        'api-settings-screen': { name: 'api', url: 'https://i.postimg.cc/50FqT8GL/chan-125.png' },
        'wallpaper-screen': { name: '壁纸', url: 'https://i.postimg.cc/3wqFttL3/chan-90.png' },
        'world-book-screen': { name: '世界书', url: 'https://i.postimg.cc/prCWkrKT/chan-74.png' },
        'customize-screen': { name: '自定义', url: 'https://i.postimg.cc/vZVdC7gt/chan-133.png' },
        'font-settings-screen': { name: '字体', url: 'https://i.postimg.cc/FzVtC0x4/chan-21.png' },
        'tutorial-screen': { name: '教程', url: 'https://i.postimg.cc/6QgNzCFf/chan-118.png' },
        'day-mode-btn': { name: '', url: 'https://i.postimg.cc/Jz0tYqnT/chan-145.png' },
        'night-mode-btn': { name: '', url: 'https://i.postimg.cc/htYvkdQK/chan-146.png' }
    };
    
    let db = { characters: [], groups: [], apiSettings: {}, wallpaper: 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg', myStickers: [], homeScreenMode: 'night', worldBooks: [], fontUrl: '', customIcons: {} };
    let currentChatId = null, currentChatType = null, isGenerating = false, longPressTimer = null, isInMultiSelectMode = false, editingMessageId = null, currentPage = 1, currentTransferMessageId = null, currentEditingWorldBookId = null, currentStickerActionTarget = null;
    let selectedMessageIds = new Set();
    const MESSAGES_PER_PAGE = 50;

    // --- DOM Element Cache ---
    const screens = document.querySelectorAll('.screen'), toastElement = document.getElementById('toast-notification'), homeScreen = document.getElementById('home-screen'), chatListContainer = document.getElementById('chat-list-container'), noChatsPlaceholder = document.getElementById('no-chats-placeholder'), addChatBtn = document.getElementById('add-chat-btn'), addCharModal = document.getElementById('add-char-modal'), addCharForm = document.getElementById('add-char-form'), chatRoomScreen = document.getElementById('chat-room-screen'), chatRoomHeaderDefault = document.getElementById('chat-room-header-default'), chatRoomHeaderSelect = document.getElementById('chat-room-header-select'), cancelMultiSelectBtn = document.getElementById('cancel-multi-select-btn'), multiSelectTitle = document.getElementById('multi-select-title'), chatRoomTitle = document.getElementById('chat-room-title'), chatRoomStatusText = document.getElementById('chat-room-status-text'), messageArea = document.getElementById('message-area'), messageInputDefault = document.getElementById('message-input-default'), messageInput = document.getElementById('message-input'), sendMessageBtn = document.getElementById('send-message-btn'), getReplyBtn = document.getElementById('get-reply-btn'), typingIndicator = document.getElementById('typing-indicator'), chatSettingsBtn = document.getElementById('chat-settings-btn'), settingsSidebar = document.getElementById('chat-settings-sidebar'), settingsForm = document.getElementById('chat-settings-form'), messageEditBar = document.getElementById('message-edit-bar'), messageEditInput = document.getElementById('message-edit-input'), saveEditBtn = document.getElementById('save-edit-btn'), cancelEditBtn = document.getElementById('cancel-edit-btn'), multiSelectBar = document.getElementById('multi-select-bar'), selectCount = document.getElementById('select-count'), deleteSelectedBtn = document.getElementById('delete-selected-btn');
    const stickerToggleBtn = document.getElementById('sticker-toggle-btn'), stickerModal = document.getElementById('sticker-modal'), stickerGridContainer = document.getElementById('sticker-grid-container'), addNewStickerBtn = document.getElementById('add-new-sticker-btn'), addStickerModal = document.getElementById('add-sticker-modal'), addStickerModalTitle = document.getElementById('add-sticker-modal-title'), addStickerForm = document.getElementById('add-sticker-form'), stickerEditIdInput = document.getElementById('sticker-edit-id'), stickerPreview = document.getElementById('sticker-preview'), stickerNameInput = document.getElementById('sticker-name'), stickerUrlInput = document.getElementById('sticker-url-input'), stickerFileUpload = document.getElementById('sticker-file-upload');
    const stickerActionSheet = document.getElementById('sticker-actionsheet'), editStickerBtn = document.getElementById('edit-sticker-btn'), deleteStickerBtn = document.getElementById('delete-sticker-btn');
    const voiceMessageBtn = document.getElementById('voice-message-btn'), sendVoiceModal = document.getElementById('send-voice-modal'), sendVoiceForm = document.getElementById('send-voice-form'), voiceTextInput = document.getElementById('voice-text-input'), voiceDurationPreview = document.getElementById('voice-duration-preview');
    const photoVideoBtn = document.getElementById('photo-video-btn'), sendPvModal = document.getElementById('send-pv-modal'), sendPvForm = document.getElementById('send-pv-form'), pvTextInput = document.getElementById('pv-text-input');
    const walletBtn = document.getElementById('wallet-btn'), sendTransferModal = document.getElementById('send-transfer-modal'), sendTransferForm = document.getElementById('send-transfer-form'), transferAmountInput = document.getElementById('transfer-amount-input'), transferRemarkInput = document.getElementById('transfer-remark-input');
    const receiveTransferActionSheet = document.getElementById('receive-transfer-actionsheet'), acceptTransferBtn = document.getElementById('accept-transfer-btn'), returnTransferBtn = document.getElementById('return-transfer-btn');
    const giftBtn = document.getElementById('gift-btn'), sendGiftModal = document.getElementById('send-gift-modal'), sendGiftForm = document.getElementById('send-gift-form'), giftDescriptionInput = document.getElementById('gift-description-input');
    const clearChatHistoryBtn = document.getElementById('clear-chat-history-btn');
    const blockContactBtn = document.getElementById('block-contact-btn'); // New Block Button
    const worldBookListContainer = document.getElementById('world-book-list-container'), noWorldBooksPlaceholder = document.getElementById('no-world-books-placeholder'), addWorldBookBtn = document.getElementById('add-world-book-btn'), editWorldBookScreen = document.getElementById('edit-world-book-screen'), editWorldBookForm = document.getElementById('edit-world-book-form'), worldBookIdInput = document.getElementById('world-book-id'), worldBookNameInput = document.getElementById('world-book-name'), worldBookContentInput = document.getElementById('world-book-content');
    const linkWorldBookBtn = document.getElementById('link-world-book-btn'), worldBookSelectionModal = document.getElementById('world-book-selection-modal'), worldBookSelectionList = document.getElementById('world-book-selection-list'), saveWorldBookSelectionBtn = document.getElementById('save-world-book-selection-btn');
    const fontSettingsForm = document.getElementById('font-settings-form'), fontUrlInput = document.getElementById('font-url'), restoreDefaultFontBtn = document.getElementById('restore-default-font-btn');
    const createGroupBtn = document.getElementById('create-group-btn'), createGroupModal = document.getElementById('create-group-modal'), createGroupForm = document.getElementById('create-group-form'), memberSelectionList = document.getElementById('member-selection-list'), groupNameInput = document.getElementById('group-name-input'), groupSettingsSidebar = document.getElementById('group-settings-sidebar'), groupSettingsForm = document.getElementById('group-settings-form'), groupMembersListContainer = document.getElementById('group-members-list-container'), editGroupMemberModal = document.getElementById('edit-group-member-modal'), editGroupMemberForm = document.getElementById('edit-group-member-form');
    const addMemberActionSheet = document.getElementById('add-member-actionsheet');
    const inviteExistingMemberBtn = document.getElementById('invite-existing-member-btn');
    const createNewMemberBtn = document.getElementById('create-new-member-btn');
    const inviteMemberModal = document.getElementById('invite-member-modal');
    const inviteMemberSelectionList = document.getElementById('invite-member-selection-list');
    const confirmInviteBtn = document.getElementById('confirm-invite-btn');
    const createMemberForGroupModal = document.getElementById('create-member-for-group-modal');
    const createMemberForGroupForm = document.getElementById('create-member-for-group-form');
    const customizeForm = document.getElementById('customize-form');
    const tutorialContentArea = document.getElementById('tutorial-content-area');
    
    // --- Utility and Core Functions ---
    const saveData = () => localStorage.setItem('gemini-chat-app-db', JSON.stringify(db));
    const loadData = () => { const data = localStorage.getItem('gemini-chat-app-db'); if (data) db = JSON.parse(data); if (!db.apiSettings) db.apiSettings = {}; if (!db.wallpaper) db.wallpaper = 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg'; if (!db.characters) db.characters = []; if (!db.groups) db.groups = []; if (!db.myStickers) db.myStickers = []; if (!db.homeScreenMode) db.homeScreenMode = 'night'; if (!db.worldBooks) db.worldBooks = []; if (!db.fontUrl) db.fontUrl = ''; if (!db.customIcons) db.customIcons = {}; db.characters.forEach(c => { if (c.isPinned === undefined) c.isPinned = false; if (c.status === undefined) c.status = '在线'; if (!c.worldBookIds) c.worldBookIds = []; if (c.isBlocked === undefined) c.isBlocked = false; }); db.groups.forEach(g => { if(g.isPinned === undefined) g.isPinned = false; }); };
    const showToast = (message) => { toastElement.textContent = message; toastElement.classList.add('show'); setTimeout(() => toastElement.classList.remove('show'), 3000); };
    const switchScreen = (targetId) => { screens.forEach(screen => screen.classList.remove('active')); document.getElementById(targetId)?.classList.add('active'); settingsSidebar.classList.remove('open'); groupSettingsSidebar.classList.remove('open'); addCharModal.classList.remove('visible'); createGroupModal.classList.remove('visible'); editGroupMemberModal.classList.remove('visible'); stickerModal.classList.remove('visible'); stickerActionSheet.classList.remove('visible'); sendVoiceModal.classList.remove('visible'); sendPvModal.classList.remove('visible'); sendTransferModal.classList.remove('visible'); sendGiftModal.classList.remove('visible'); receiveTransferActionSheet.classList.remove('visible'); worldBookSelectionModal.classList.remove('visible'); addMemberActionSheet.classList.remove('visible'); inviteMemberModal.classList.remove('visible'); createMemberForGroupModal.classList.remove('visible');};
    const pad = (num) => num.toString().padStart(2, '0');
    function createContextMenu(items, x, y) { removeContextMenu(); const menu = document.createElement('div'); menu.className = 'context-menu'; menu.style.left = `${x}px`; menu.style.top = `${y}px`; items.forEach(item => { const menuItem = document.createElement('div'); menuItem.className = 'context-menu-item'; if (item.danger) menuItem.classList.add('danger'); menuItem.textContent = item.label; menuItem.onclick = () => { item.action(); removeContextMenu(); }; menu.appendChild(menuItem); }); document.body.appendChild(menu); document.addEventListener('click', removeContextMenu, { once: true }); }
    function removeContextMenu() { const menu = document.querySelector('.context-menu'); if (menu) menu.remove(); }
    const init = () => { loadData(); document.body.addEventListener('click', (e) => { if (e.target.closest('.context-menu')) { e.stopPropagation(); return; } removeContextMenu(); const navLink = e.target.closest('.app-icon'); if (navLink && !navLink.id.includes('-mode-btn')) { e.preventDefault(); switchScreen(navLink.getAttribute('data-target')); } const backBtn = e.target.closest('.back-btn'); if(backBtn) { e.preventDefault(); switchScreen(backBtn.getAttribute('data-target')); } if (stickerModal.classList.contains('visible') && !stickerModal.contains(e.target) && !e.target.closest('#sticker-toggle-btn')) { stickerModal.classList.remove('visible'); } if (stickerActionSheet.classList.contains('visible') && e.target === stickerActionSheet) { stickerActionSheet.classList.remove('visible'); currentStickerActionTarget = null; } if (addMemberActionSheet.classList.contains('visible') && e.target === addMemberActionSheet) { addMemberActionSheet.classList.remove('visible'); } }); updateClock(); setInterval(updateClock, 30000); applyGlobalFont(db.fontUrl); setupHomeScreen(); setupChatListScreen(); setupAddCharModal(); setupChatRoom(); setupChatSettings(); setupApiSettingsApp(); setupWallpaperApp(); setupStickerSystem(); setupVoiceMessageSystem(); setupPhotoVideoSystem(); setupWalletSystem(); setupGiftSystem(); setupWorldBookApp(); setupFontSettingsApp(); setupGroupChatSystem(); setupCustomizeApp(); setupTutorialApp(); };
    function updateClock() { const now = new Date(); const timeDisplay = document.getElementById('time-display'); const dateDisplay = document.getElementById('date-display'); if (timeDisplay) timeDisplay.textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}`; if (dateDisplay) dateDisplay.textContent = `${now.getFullYear()}年${pad(now.getMonth() + 1)}月${pad(now.getDate())}日`; }
    
    // --- App Setup Functions ---
    function setupHomeScreen() {
        const getIcon = (id) => db.customIcons[id] || defaultIcons[id].url;
        
        const homeScreenHTML = `
            <div class="time-widget"><div class="time" id="time-display"></div><div class="date" id="date-display"></div></div>
            <div class="app-grid">
                <a href="#" class="app-icon" data-target="chat-list-screen"><img src="${getIcon('chat-list-screen')}" alt="404" class="icon-img"><span class="app-name">${defaultIcons['chat-list-screen'].name}</span></a>
                <a href="#" class="app-icon" data-target="api-settings-screen"><img src="${getIcon('api-settings-screen')}" alt="API" class="icon-img"><span class="app-name">${defaultIcons['api-settings-screen'].name}</span></a>
                <a href="#" class="app-icon" data-target="wallpaper-screen"><img src="${getIcon('wallpaper-screen')}" alt="Wallpaper" class="icon-img"><span class="app-name">${defaultIcons['wallpaper-screen'].name}</span></a>
                <a href="#" class="app-icon" data-target="world-book-screen"><img src="${getIcon('world-book-screen')}" alt="World Book" class="icon-img"><span class="app-name">${defaultIcons['world-book-screen'].name}</span></a>
                <a href="#" class="app-icon" data-target="customize-screen"><img src="${getIcon('customize-screen')}" alt="Customize" class="icon-img"><span class="app-name">${defaultIcons['customize-screen'].name}</span></a>
                <a href="#" class="app-icon" data-target="tutorial-screen"><img src="${getIcon('tutorial-screen')}" alt="Tutorial" class="icon-img"><span class="app-name">${defaultIcons['tutorial-screen'].name}</span></a>
            </div>
            <div class="dock">
                <a href="#" class="app-icon" id="day-mode-btn"><img src="${getIcon('day-mode-btn')}" alt="日间" class="icon-img"></a>
                <a href="#" class="app-icon" id="night-mode-btn"><img src="${getIcon('night-mode-btn')}" alt="夜间" class="icon-img"></a>
                <a href="#" class="app-icon" data-target="font-settings-screen"><img src="${getIcon('font-settings-screen')}" alt="字体" class="icon-img"></a>
            </div>`;
        homeScreen.innerHTML = homeScreenHTML;
        
        updateClock(); // Make sure clock is updated immediately
        applyWallpaper(db.wallpaper);
        applyHomeScreenMode(db.homeScreenMode);
        document.getElementById('day-mode-btn')?.addEventListener('click', (e) => { e.preventDefault(); applyHomeScreenMode('day'); });
        document.getElementById('night-mode-btn')?.addEventListener('click', (e) => { e.preventDefault(); applyHomeScreenMode('night'); });
        document.querySelector('[data-target="world-book-screen"]').addEventListener('click', renderWorldBookList);
        document.querySelector('[data-target="customize-screen"]').addEventListener('click', renderCustomizeForm);
        document.querySelector('[data-target="tutorial-screen"]').addEventListener('click', renderTutorialContent);
    }
    
    function applyWallpaper(url) { homeScreen.style.backgroundImage = `url(${url})`; }
    function applyHomeScreenMode(mode) { if (mode === 'day') { homeScreen.classList.add('day-mode'); } else { homeScreen.classList.remove('day-mode'); } db.homeScreenMode = mode; saveData(); }

    function setupCustomizeApp() {
        customizeForm.addEventListener('input', e => {
            if (e.target.matches('input[type="url"]')) {
                const iconId = e.target.dataset.id;
                const newUrl = e.target.value.trim();
                const previewImg = document.getElementById(`icon-preview-${iconId}`);
                if (newUrl) {
                    db.customIcons[iconId] = newUrl;
                    previewImg.src = newUrl;
                    saveData();
                    setupHomeScreen(); // Refresh home screen to apply new icon
                }
            }
        });

        customizeForm.addEventListener('click', e => {
            if (e.target.matches('.reset-icon-btn')) {
                const iconId = e.target.dataset.id;
                delete db.customIcons[iconId];
                saveData();
                renderCustomizeForm();
                setupHomeScreen();
                showToast('图标已重置');
            }
        });
    }

    function renderCustomizeForm() {
        customizeForm.innerHTML = '';
        Object.entries(defaultIcons).forEach(([id, { name, url }]) => {
            const currentIcon = db.customIcons[id] || url;
            const itemHTML = `
                <div class="icon-custom-item">
                    <img src="${currentIcon}" alt="${name}" class="icon-preview" id="icon-preview-${id}">
                    <div class="icon-details">
                        <p>${name || '模式切换'}</p>
                        <input type="url" class="form-group" placeholder="粘贴新的图标URL" value="${db.customIcons[id] || ''}" data-id="${id}">
                    </div>
                    <button type="button" class="reset-icon-btn" data-id="${id}">重置</button>
                </div>
            `;
            customizeForm.insertAdjacentHTML('beforeend', itemHTML);
        });
    }

    function setupTutorialApp() {
        tutorialContentArea.addEventListener('click', (e) => {
            const header = e.target.closest('.tutorial-header');
            if (header) {
                header.parentElement.classList.toggle('open');
            }
        });
    }
    
function renderTutorialContent() {
    // 注意看！这里的数据结构变了，变成了 imageUrls 数组
    const tutorials = [
        { title: '1', imageUrls: ['https://1.jpg'] },
        { title: '软件介绍', imageUrls: [
            'https://i.postimg.cc/VvsJRh6q/IMG-20250713-162647.jpg',
            'https://i.postimg.cc/8P5FfxxD/IMG-20250713-162702.jpg',
            'https://i.postimg.cc/3r94R3Sn/IMG-20250713-162712.jpg'
        ] }, // <- 这里是你的两张新图片
        { title: '404', imageUrls: [
            'https://i.postimg.cc/x8scFPJW/IMG-20250713-162756.jpg',
            'https://i.postimg.cc/pX6mfqtj/IMG-20250713-162809.jpg',
            'https://i.postimg.cc/YScjV00q/IMG-20250713-162819.jpg',
            'https://i.postimg.cc/13VfJw9j/IMG-20250713-162828.jpg'
        ] }, // <- 这里也是你的两张新图片
        { title: '404-群聊', imageUrls: ['https://i.postimg.cc/X7LSmRTJ/404.jpg'] }
    ];

    tutorialContentArea.innerHTML = '';
    tutorials.forEach(tutorial => {
        const item = document.createElement('div');
        item.className = 'tutorial-item';
        
        // 这里会遍历 imageUrls 数组，生成一个包含所有图片的 HTML 字符串
        const imagesHtml = tutorial.imageUrls.map(url => 
            `<img src="${url}" alt="${tutorial.title}教程图片">`
        ).join('');

        item.innerHTML = `
            <div class="tutorial-header">${tutorial.title}</div>
            <div class="tutorial-content">
                ${imagesHtml} 
            </div>
        `;
        tutorialContentArea.appendChild(item);
    });
}

    // --- Chat List & Chat Room ---
    function setupChatListScreen() {
        renderChatList();
        addChatBtn.addEventListener('click', () => { addCharModal.classList.add('visible'); addCharForm.reset(); });
        chatListContainer.addEventListener('click', (e) => {
            const chatItem = e.target.closest('.chat-item');
            if (chatItem) {
                currentChatId = chatItem.dataset.id;
                currentChatType = chatItem.dataset.type;
                openChatRoom(currentChatId, currentChatType);
            }
        });
chatListContainer.addEventListener('contextmenu', (e) => {
    e.preventDefault(); 
    
    const chatItem = e.target.closest('.chat-item');
    if (!chatItem) return;
    
    handleChatListLongPress(chatItem.dataset.id, chatItem.dataset.type, e.clientX, e.clientY);
});
        chatListContainer.addEventListener('touchstart', (e) => { const chatItem = e.target.closest('.chat-item'); if (!chatItem) return; longPressTimer = setTimeout(() => { const touch = e.touches[0]; handleChatListLongPress(chatItem.dataset.id, chatItem.dataset.type, touch.clientX, touch.clientY); }, 400); });
        chatListContainer.addEventListener('touchend', () => clearTimeout(longPressTimer));
        chatListContainer.addEventListener('touchmove', () => clearTimeout(longPressTimer));
    }
    
    function handleChatListLongPress(chatId, chatType, x, y) {
        clearTimeout(longPressTimer);
        const chatItem = (chatType === 'private') ? db.characters.find(c => c.id === chatId) : db.groups.find(g => g.id === chatId);
        if (!chatItem) return;
        const itemName = chatType === 'private' ? chatItem.remarkName : chatItem.name;
        const menuItems = [ { label: chatItem.isPinned ? '取消置顶' : '置顶聊天', action: () => { chatItem.isPinned = !chatItem.isPinned; saveData(); renderChatList(); } }, { label: '删除聊天', danger: true, action: () => { if (confirm(`确定要删除与“${itemName}”的聊天记录吗？此操作不可恢复。`)) { if (chatType === 'private') { db.characters = db.characters.filter(c => c.id !== chatId); } else { db.groups = db.groups.filter(g => g.id !== chatId); } saveData(); renderChatList(); showToast('聊天已删除'); } } } ];
        createContextMenu(menuItems, x, y);
    }
    
    function renderChatList() {
        chatListContainer.innerHTML = '';
        const allChats = [
            ...db.characters.map(c => ({...c, type: 'private'})),
            ...db.groups.map(g => ({...g, type: 'group'}))
        ];

        noChatsPlaceholder.style.display = (db.characters.length + db.groups.length) === 0 ? 'block' : 'none';
        
        const sortedChats = allChats.sort((a, b) => {
            if (a.isPinned !== b.isPinned) return a.isPinned ? -1 : 1;
            const lastMsgTimeA = a.history && a.history.length > 0 ? a.history[a.history.length - 1].timestamp : 0;
            const lastMsgTimeB = b.history && b.history.length > 0 ? b.history[b.history.length - 1].timestamp : 0;
            return lastMsgTimeB - lastMsgTimeA;
        });

        sortedChats.forEach(chat => {
            let lastMessageText = '开始聊天吧...';
            if (chat.history && chat.history.length > 0) {
                 const visibleHistory = chat.history.filter(msg => {
                    const invisibleRegex = /\[.*?(?:接收|退回).*?的转账\]|\[.*?更新状态为：.*?\]|\[.*?已接收礼物\]|\[system:.*?\]|\[.*?邀请.*?加入了群聊\]|\[.*?修改群名为：.*?\]|\[.*?已将.*?拉黑\]|\[.*?已将.*?解除拉黑\]/;
                    return !invisibleRegex.test(msg.content);
                });
                
                if (visibleHistory.length > 0) {
                    const lastMsg = visibleHistory[visibleHistory.length - 1];
                    const urlRegex = /^(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg))$/i;
                    const voiceRegex = /\[.*?的语音：.*?\]/;
                    const photoVideoRegex = /\[.*?发来的照片\/视频：.*?\]/;
                    const transferRegex = /\[.*?的转账：.*?元.*?\]|\[.*?给你转账：.*?元.*?\]/;
                    const stickerRegex = /\[.*?的表情包：.*?\]|\[.*?发送的表情包：.*?\]/;
                    const giftRegex = /\[.*?送来的礼物：.*?\]/;
                    const blockedRegex = /\[.*?被拉黑后的消息：.*?\]/;

                    if (giftRegex.test(lastMsg.content)) {
                        lastMessageText = '[礼物]';
                    } else if(stickerRegex.test(lastMsg.content)) {
                        lastMessageText = '[表情包]';
                    } else if (voiceRegex.test(lastMsg.content)) {
                        lastMessageText = '[语音]';
                    } else if (photoVideoRegex.test(lastMsg.content)) {
                        lastMessageText = '[照片/视频]';
                    } else if (transferRegex.test(lastMsg.content)) {
                        lastMessageText = '[转账]';
                    } else {
                        const textMatch = lastMsg.content.match(/\[.*?的消息：([\s\S]+)\]/);
                        const blockedMatch = lastMsg.content.match(blockedRegex);
                        let text = textMatch ? textMatch[1].trim() : lastMsg.content.trim();
                        if (blockedMatch) text = blockedMatch[1].trim();
                        lastMessageText = urlRegex.test(text) ? '[图片]' : text;
                    }
                } else { // If only invisible messages exist, check the very last one
                    const lastEverMsg = chat.history[chat.history.length - 1];
                    const inviteRegex = /\[(.*?)邀请(.*?)加入了群聊\]/;
                    const renameRegex = /\[.*?修改群名为：.*?\]/;
                    const blockRegex = /\[.*?已将.*?拉黑\]/;
                    const unblockRegex = /\[.*?已将.*?解除拉黑\]/;
                    if(inviteRegex.test(lastEverMsg.content)) {
                        lastMessageText = '新成员加入了群聊';
                    }
                    if(renameRegex.test(lastEverMsg.content)) {
                        lastMessageText = '群聊名称已修改';
                    }
                    if(blockRegex.test(lastEverMsg.content)) {
                        lastMessageText = '你已拉黑对方';
                    }
                    if(unblockRegex.test(lastEverMsg.content)) {
                        lastMessageText = '你已解除拉黑';
                    }
                }
            }
            
            const li = document.createElement('li');
            li.className = 'list-item chat-item';
            if (chat.isPinned) li.classList.add('pinned');
            li.dataset.id = chat.id;
            li.dataset.type = chat.type;
            
            const avatarClass = chat.type === 'group' ? 'group-avatar' : '';
            const itemName = chat.type === 'private' ? chat.remarkName : chat.name;
            const pinBadgeHTML = chat.isPinned ? '<span class="pin-badge">置顶</span>' : '';

            li.innerHTML = `
                <img src="${chat.avatar}" alt="${itemName}" class="chat-avatar ${avatarClass}">
                <div class="item-details">
                    <div class="item-details-row">
                        <div class="item-name">${itemName}</div>
                    </div>
                    <div class="item-preview-wrapper">
                        <div class="item-preview">${lastMessageText}</div>
                        ${pinBadgeHTML}
                    </div>
                </div>`;
            chatListContainer.appendChild(li);
        });
    }

    function setupAddCharModal() { addCharForm.addEventListener('submit', (e) => { e.preventDefault(); const newChar = { id: `char_${Date.now()}`, realName: document.getElementById('char-real-name').value, remarkName: document.getElementById('char-remark-name').value, persona: '', avatar: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg', myName: document.getElementById('my-name-for-char').value, myPersona: '', myAvatar: 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg', theme: 'white_pink', maxMemory: 10, chatBg: '', history: [], isPinned: false, status: '在线', worldBookIds: [], isBlocked: false }; db.characters.push(newChar); saveData(); renderChatList(); addCharModal.classList.remove('visible'); showToast(`角色“${newChar.remarkName}”创建成功！`); }); addCharModal.addEventListener('click', (e) => { if (e.target === addCharModal) addCharModal.classList.remove('visible'); }); }
    function setupChatRoom() {
        sendMessageBtn.addEventListener('click', sendMessage);
        sendMessageBtn.addEventListener('touchend', (e) => {
            e.preventDefault(); 
            sendMessage();
            setTimeout(() => { messageInput.focus(); }, 50);
        });

        messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !isGenerating) sendMessage(); });
        getReplyBtn.addEventListener('click', getAiReply);
        messageArea.addEventListener('click', (e) => {
            if (e.target && e.target.id === 'load-more-btn') {
                loadMoreMessages();
            } else if (isInMultiSelectMode) {
                const messageWrapper = e.target.closest('.message-wrapper');
                if (messageWrapper) { toggleMessageSelection(messageWrapper.dataset.id); }
            } else {
                const voiceBubble = e.target.closest('.voice-bubble');
                if (voiceBubble) {
                    const transcript = voiceBubble.closest('.message-wrapper').querySelector('.voice-transcript');
                    if (transcript) { transcript.classList.toggle('active'); }
                }
                const pvCard = e.target.closest('.pv-card');
                if (pvCard) {
                    const imageOverlay = pvCard.querySelector('.pv-card-image-overlay');
                    const footer = pvCard.querySelector('.pv-card-footer');
                    imageOverlay.classList.toggle('hidden');
                    footer.classList.toggle('hidden');
                }
                const giftCard = e.target.closest('.gift-card');
                if(giftCard) {
                    const description = giftCard.closest('.message-wrapper').querySelector('.gift-card-description');
                    if (description) { description.classList.toggle('active'); }
                }
                const transferCard = e.target.closest('.transfer-card.received-transfer');
                if (transferCard && currentChatType === 'private') { 
                    const messageWrapper = transferCard.closest('.message-wrapper');
                    const messageId = messageWrapper.dataset.id;
                    const character = db.characters.find(c => c.id === currentChatId);
                    const message = character.history.find(m => m.id === messageId);
                    if (message && message.transferStatus === 'pending') {
                         handleReceivedTransferClick(messageId);
                    }
                }
            }
        });
messageArea.addEventListener('contextmenu', (e) => {
    e.preventDefault(); 

    if (e.target.id === 'load-more-btn' || isInMultiSelectMode) return;
    
    const messageWrapper = e.target.closest('.message-wrapper');
    if (!messageWrapper) return;

    handleMessageLongPress(messageWrapper, e.clientX, e.clientY);
});
        messageArea.addEventListener('touchstart', (e) => { if (e.target.id === 'load-more-btn') return; const messageWrapper = e.target.closest('.message-wrapper'); if (!messageWrapper) return; longPressTimer = setTimeout(() => { const touch = e.touches[0]; handleMessageLongPress(messageWrapper, touch.clientX, touch.clientY); }, 400); });
        messageArea.addEventListener('touchend', () => clearTimeout(longPressTimer));
        messageArea.addEventListener('touchmove', () => clearTimeout(longPressTimer));
        saveEditBtn.addEventListener('click', saveMessageEdit);
        cancelEditBtn.addEventListener('click', cancelMessageEdit);
        cancelMultiSelectBtn.addEventListener('click', exitMultiSelectMode);
        deleteSelectedBtn.addEventListener('click', deleteSelectedMessages);
    }
    function handleMessageLongPress(messageWrapper, x, y) {
        if (isInMultiSelectMode) return;
        clearTimeout(longPressTimer);
        const messageId = messageWrapper.dataset.id;
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
        const message = chat.history.find(m => m.id === messageId);
        if (!message) return;

        const isVoiceMessage = /\[.*?的语音：.*?\]/.test(message.content);
        const isStickerMessage = /\[.*?的表情包：.*?\]|\[.*?发送的表情包：.*?\]/.test(message.content);
        const isPhotoVideoMessage = /\[.*?发来的照片\/视频：.*?\]/.test(message.content);
        const isTransferMessage = /\[.*?给你转账：.*?\]|\[.*?的转账：.*?\]/.test(message.content);
        const isGiftMessage = /\[.*?送来的礼物：.*?\]/.test(message.content);
        const isInvisibleMessage = /\[.*?(?:接收|退回).*?的转账\]|\[.*?更新状态为：.*?\]|\[.*?已接收礼物\]|\[system:.*?\]|\[.*?邀请.*?加入了群聊\]|\[.*?修改群名为：.*?\]|\[.*?已将.*?拉黑\]|\[.*?已将.*?解除拉黑\]/.test(message.content);
        
        let menuItems = [];
        if (!isVoiceMessage && !isStickerMessage && !isPhotoVideoMessage && !isTransferMessage && !isGiftMessage && !isInvisibleMessage) {
            menuItems.push({ label: '编辑', action: () => startMessageEdit(messageId) });
        }
        menuItems.push({ label: '删除', action: () => enterMultiSelectMode(messageId) });

        if (menuItems.length > 0) {
            createContextMenu(menuItems, x, y);
        }
    }
    function startMessageEdit(messageId) { exitMultiSelectMode(); editingMessageId = messageId; const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId); const message = chat.history.find(m => m.id === messageId); if (!message) return; const match = message.content.match(/\[.*?的消息：([\s\S]+)\]/); const contentToEdit = match ? match[1].trim() : message.content; messageEditInput.value = contentToEdit; messageInputDefault.style.display = 'none'; messageEditBar.style.display = 'flex'; messageEditInput.focus(); }
    function saveMessageEdit() { const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId); const messageIndex = chat.history.findIndex(m => m.id === editingMessageId); if (messageIndex === -1) return; const newText = messageEditInput.value.trim(); if (newText) { const oldContent = chat.history[messageIndex].content; const prefixMatch = oldContent.match(/(\[.*?的消息：)[\s\S]+\]/); const prefix = prefixMatch ? prefixMatch[1] : ''; chat.history[messageIndex].content = `${prefix}${newText}]`; saveData(); currentPage = 1; renderMessages(false, true); renderChatList(); } cancelMessageEdit(); }
    function cancelMessageEdit() { editingMessageId = null; messageInputDefault.style.display = 'flex'; messageEditBar.style.display = 'none'; }
    function enterMultiSelectMode(initialMessageId) { isInMultiSelectMode = true; chatRoomHeaderDefault.style.display = 'none'; chatRoomHeaderSelect.style.display = 'flex'; document.querySelector('.chat-input-wrapper').style.display='none'; multiSelectBar.classList.add('visible'); chatRoomScreen.classList.add('multi-select-active'); selectedMessageIds.clear(); if (initialMessageId) { toggleMessageSelection(initialMessageId); } }
    function exitMultiSelectMode() { isInMultiSelectMode = false; chatRoomHeaderDefault.style.display = 'flex'; chatRoomHeaderSelect.style.display = 'none'; document.querySelector('.chat-input-wrapper').style.display='block'; multiSelectBar.classList.remove('visible'); chatRoomScreen.classList.remove('multi-select-active'); selectedMessageIds.forEach(id => { const el = messageArea.querySelector(`.message-wrapper[data-id="${id}"]`); if (el) el.classList.remove('multi-select-selected'); }); selectedMessageIds.clear(); }
    function toggleMessageSelection(messageId) { const el = messageArea.querySelector(`.message-wrapper[data-id="${messageId}"]`); if (!el) return; if (selectedMessageIds.has(messageId)) { selectedMessageIds.delete(messageId); el.classList.remove('multi-select-selected'); } else { selectedMessageIds.add(messageId); el.classList.add('multi-select-selected'); } selectCount.textContent = `已选择 ${selectedMessageIds.size} 项`; deleteSelectedBtn.disabled = selectedMessageIds.size === 0; }
function deleteSelectedMessages() {
    if (selectedMessageIds.size === 0) return;
    const deletedCount = selectedMessageIds.size; 

    const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
    chat.history = chat.history.filter(m => !selectedMessageIds.has(m.id));
    saveData();
    currentPage = 1;
    renderMessages(false, true);
    renderChatList();
    exitMultiSelectMode();
    showToast(`已删除 ${deletedCount} 条消息`); 
}
    
    function openChatRoom(chatId, type) {
        const chat = (type === 'private') ? db.characters.find(c => c.id === chatId) : db.groups.find(g => g.id === chatId);
        if (!chat) return;
        exitMultiSelectMode();
        cancelMessageEdit();
        chatRoomTitle.textContent = (type === 'private') ? chat.remarkName : chat.name;
        
        const subtitle = document.getElementById('chat-room-subtitle');
        if (type === 'private') {
            subtitle.style.display = 'flex';
            chatRoomStatusText.textContent = chat.status || '在线';
            getReplyBtn.style.display = 'inline-flex';
        } else {
            subtitle.style.display = 'none'; 
            getReplyBtn.style.display = 'inline-flex';
        }

        chatRoomScreen.style.backgroundImage = chat.chatBg ? `url(${chat.chatBg})` : 'none';
        typingIndicator.style.display = 'none';
        isGenerating = false;
        getReplyBtn.disabled = false;
        currentPage = 1;
        renderMessages(false, true);
        switchScreen('chat-room-screen');
    }

    function renderMessages(isLoadMore = false, forceScrollToBottom = false) {
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
        if (!chat || !chat.history) return;
        const oldScrollHeight = messageArea.scrollHeight;
        const totalMessages = chat.history.length;
        const end = totalMessages - (currentPage - 1) * MESSAGES_PER_PAGE;
        const start = Math.max(0, end - MESSAGES_PER_PAGE);
        const messagesToRender = chat.history.slice(start, end);
        if (!isLoadMore) messageArea.innerHTML = '';
        const fragment = document.createDocumentFragment();
        messagesToRender.forEach(msg => { const bubble = createMessageBubbleElement(msg); if(bubble) fragment.appendChild(bubble); });
        const existingLoadBtn = document.getElementById('load-more-btn');
        if (existingLoadBtn) existingLoadBtn.remove();
        messageArea.prepend(fragment);
        if (totalMessages > currentPage * MESSAGES_PER_PAGE) {
            const loadMoreButton = document.createElement('button');
            loadMoreButton.id = 'load-more-btn';
            loadMoreButton.className = 'load-more-btn';
            loadMoreButton.textContent = '加载更早的消息';
            messageArea.prepend(loadMoreButton);
        }
        
        if (forceScrollToBottom) {
            setTimeout(() => { messageArea.scrollTop = messageArea.scrollHeight; }, 0);
        } else if (isLoadMore) {
            messageArea.scrollTop = messageArea.scrollHeight - oldScrollHeight;
        }
    }
    
    function loadMoreMessages() { currentPage++; renderMessages(true, false); }
    function calculateVoiceDuration(text) { const wordsPerSecond = 3.5; const duration = Math.ceil(text.length / wordsPerSecond); return Math.max(1, Math.min(60, duration)); }
    
    function createMessageBubbleElement(message) {
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
        const { role, content, timestamp, id, transferStatus, giftStatus, stickerData, senderId } = message;
        
        const inviteRegex = /\[(.*?)邀请(.*?)加入了群聊\]/;
        const inviteMatch = content.match(inviteRegex);
        
        const renameRegex = /\[(.*?)修改群名为：(.*?)\]/;
        const renameMatch = content.match(renameRegex);
        
        const blockRegex = new RegExp(`\\[${chat.myName}已将${chat.realName}拉黑\\]`);
        const unblockRegex = new RegExp(`\\[${chat.myName}已将${chat.realName}解除拉黑\\]`);
        const blockMatch = content.match(blockRegex);
        const unblockMatch = content.match(unblockRegex);

        const invisibleRegex = /\[.*?(?:接收|退回).*?的转账\]|\[.*?更新状态为：.*?\]|\[.*?已接收礼物\]|\[system:.*?\]/;
        if (invisibleRegex.test(content)) {
            return null;
        }

        const wrapper = document.createElement('div');
        wrapper.dataset.id = id;

        if (blockMatch) {
            wrapper.className = 'message-wrapper system-notification';
            wrapper.innerHTML = `<div class="system-notification-bubble">您已将${chat.realName}拉黑</div>`;
            return wrapper;
        }

        if (unblockMatch) {
            wrapper.className = 'message-wrapper system-notification';
            wrapper.innerHTML = `<div class="system-notification-bubble">您已将${chat.realName}解除拉黑</div>`;
            return wrapper;
        }
        
        if (inviteMatch) {
            const inviter = inviteMatch[1];
            const invitee = inviteMatch[2];
            wrapper.className = 'message-wrapper system-notification';
            wrapper.innerHTML = `<div class="system-notification-bubble">${inviter}邀请${invitee}加入了群聊</div>`;
            return wrapper;
        }
        
        if (renameMatch) {
            const modifier = renameMatch[1];
            const newName = renameMatch[2];
            wrapper.className = 'message-wrapper system-notification';
            wrapper.innerHTML = `<div class="system-notification-bubble">${modifier}修改群名为“${newName}”</div>`;
            return wrapper;
        }

        const isSent = (role === 'user');
        
        let avatarUrl, bubbleTheme, senderNickname = '';
        const themeKey = chat.theme || 'white_pink';
        const theme = colorThemes[themeKey] || colorThemes['white_pink'];
        
        if (isSent) {
            avatarUrl = (currentChatType === 'private') ? chat.myAvatar : chat.me.avatar;
            bubbleTheme = theme.sent;
        } else { // Received message
            if (currentChatType === 'private') {
                 avatarUrl = chat.avatar;
            } else { // Group chat received message
                const sender = chat.members.find(m => m.id === senderId);
                if (sender) {
                    avatarUrl = sender.avatar;
                    senderNickname = sender.groupNickname;
                } else {
                    avatarUrl = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
                }
            }
            bubbleTheme = theme.received;
        }

        const timeString = `${pad(new Date(timestamp).getHours())}:${pad(new Date(timestamp).getMinutes())}`;
        
        wrapper.className = `message-wrapper ${isSent ? 'sent' : 'received'}`;
        if (currentChatType === 'group' && !isSent) {
            wrapper.classList.add('group-message');
        }

        const bubbleRow = document.createElement('div');
        bubbleRow.className = 'message-bubble-row';

        let bubbleElement;

        const sentStickerRegex = /\[(?:.+?)的表情包：.+?\]/i;
        const receivedStickerRegex = /\[(?:.+?)发送的表情包：(https?:\/\/[^\s]+?\.(?:jpg|jpeg|png|gif|webp|bmp|svg))\]/i;
        const voiceRegex = /\[(?:.+?)的语音：([\s\S]+?)\]/;
        const photoVideoRegex = /\[(?:.+?)发来的照片\/视频：([\s\S]+?)\]/;
        const sentTransferRegex = /\[.*?给你转账：([\d.]+)元；备注：(.*?)\]/;
        const receivedTransferRegex = /\[.*?的转账：([\d.]+)元；备注：(.*?)\]/;
        const giftRegex = /\[(?:.+?)送来的礼物：([\s\S]+?)\]/;
        const blockedMessageRegex = new RegExp(`\\[${chat.realName}被拉黑后的消息：([\\s\\S]+?)\\]`);
        const textRegex = /\[(?:.+?)的消息：([\s\S]+?)\]/;

        const sentStickerMatch = content.match(sentStickerRegex);
        const receivedStickerMatch = content.match(receivedStickerRegex);
        const voiceMatch = content.match(voiceRegex);
        const photoVideoMatch = content.match(photoVideoRegex);
        const sentTransferMatch = content.match(sentTransferRegex);
        const receivedTransferMatch = content.match(receivedTransferRegex);
        const giftMatch = content.match(giftRegex);
        const blockedMatch = content.match(blockedMessageRegex);
        const textMatch = content.match(textRegex);


        if (isSent && sentStickerMatch && stickerData) {
            bubbleElement = document.createElement('div');
            bubbleElement.className = 'image-bubble';
            const img = document.createElement('img');
            img.src = stickerData;
            img.alt = '表情包';
            bubbleElement.appendChild(img);
        } else if (!isSent && receivedStickerMatch) {
            const url = receivedStickerMatch[1];
            bubbleElement = document.createElement('div');
            bubbleElement.className = 'image-bubble';
            const img = document.createElement('img');
            img.src = url;
            img.alt = '表情包';
            bubbleElement.appendChild(img);
        } else if (giftMatch) {
            const description = giftMatch[1].trim();
            bubbleElement = document.createElement('div');
            bubbleElement.className = 'gift-card';
            if (giftStatus === 'received') {
                bubbleElement.classList.add('received');
            }
            bubbleElement.innerHTML = `<img src="https://i.postimg.cc/rp0Yg31K/chan-75.png" alt="gift" class="gift-card-icon"><div class="gift-card-text">您有一份礼物～</div><div class="gift-card-received-stamp">已查收</div>`;

            const descriptionDiv = document.createElement('div');
            descriptionDiv.className = 'gift-card-description';
            descriptionDiv.textContent = description;
            wrapper.appendChild(descriptionDiv);

        } else if (voiceMatch) {
            const voiceText = voiceMatch[1].trim();
            const duration = calculateVoiceDuration(voiceText);
            bubbleElement = document.createElement('div');
            bubbleElement.className = 'voice-bubble';
            bubbleElement.style.backgroundColor = bubbleTheme.bg;
            bubbleElement.style.color = bubbleTheme.text;
            const playIconSvg = `<svg class="play-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>`;
            const durationSpan = `<span class="duration">${duration}"</span>`;
            bubbleElement.innerHTML = `${playIconSvg}${durationSpan}`;
            const transcriptDiv = document.createElement('div');
            transcriptDiv.className = 'voice-transcript';
            transcriptDiv.textContent = voiceText;
            wrapper.appendChild(transcriptDiv);
        } else if (photoVideoMatch) {
            const description = photoVideoMatch[1].trim();
            const imageUrl = isSent ? 'https://i.postimg.cc/L8NFrBrW/1752307494497.jpg' : 'https://i.postimg.cc/1tH6ds9g/1752301200490.jpg';
            bubbleElement = document.createElement('div');
            bubbleElement.className = 'pv-card';
            bubbleElement.innerHTML = `<div class="pv-card-content">${description}</div><div class="pv-card-image-overlay" style="background-image: url('${imageUrl}');"></div><div class="pv-card-footer"><svg viewBox="0 0 24 24"><path d="M4,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M4,6V18H20V6H4M10,9A1,1 0 0,1 11,10A1,1 0 0,1 10,11A1,1 0 0,1 9,10A1,1 0 0,1 10,9M8,17L11,13L13,15L17,10L20,14V17H8Z"></path></svg><span>照片/视频・点击查看</span></div>`;
        } else if (sentTransferMatch || receivedTransferMatch) {
            const isSentTransfer = !!sentTransferMatch;
            const match = isSentTransfer ? sentTransferMatch : receivedTransferMatch;
            const amount = parseFloat(match[1]).toFixed(2);
            const remarkText = match[2] || (isSentTransfer ? '' : '');
            
            bubbleElement = document.createElement('div');
            bubbleElement.className = `transfer-card ${isSentTransfer ? 'sent-transfer' : 'received-transfer'}`;
            
            let statusText = isSentTransfer ? '待查收' : '转账给你';
            let titleText = isSentTransfer ? '给你转账' : `转账`;

            if (transferStatus === 'received') {
                statusText = '已收款';
                bubbleElement.classList.add('received');
            } else if (transferStatus === 'returned') {
                statusText = '已退回';
                bubbleElement.classList.add('returned');
            }
            if (transferStatus !== 'pending' || currentChatType === 'group') {
                bubbleElement.style.cursor = 'default';
            }
            
            const remarkHTML = remarkText ? `<p class="transfer-remark">${remarkText}</p>` : '';

            bubbleElement.innerHTML = `<div class="overlay"></div><div class="transfer-content"><p class="transfer-title">${titleText}</p><p class="transfer-amount">¥${amount}</p>${remarkHTML}<p class="transfer-status">${statusText}</p></div>`;

        } else if (blockedMatch) {
            const textContent = blockedMatch[1].trim();
            bubbleElement = document.createElement('div');
            bubbleElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
            bubbleElement.textContent = textContent;
            bubbleElement.style.backgroundColor = bubbleTheme.bg;
            bubbleElement.style.color = bubbleTheme.text;
            
            const indicator = document.createElement('div');
            indicator.className = 'blocked-indicator';
            indicator.textContent = '!';
            bubbleRow.appendChild(indicator);

        } else if (textMatch) {
            const urlRegex = /^(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg))$/i;
            let textContent = textMatch[1].trim();

            const isImage = urlRegex.test(textContent);
            if (isImage) {
                bubbleElement = document.createElement('div');
                bubbleElement.className = 'image-bubble';
                const img = document.createElement('img');
                img.src = textContent;
                img.alt = '图片消息';
                bubbleElement.appendChild(img);
            } else {
                bubbleElement = document.createElement('div');
                bubbleElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
                bubbleElement.textContent = textContent;
                bubbleElement.style.backgroundColor = bubbleTheme.bg;
                bubbleElement.style.color = bubbleTheme.text;
            }
        } else {
            bubbleElement = document.createElement('div');
            bubbleElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
            bubbleElement.textContent = content; 
            bubbleElement.style.backgroundColor = bubbleTheme.bg;
            bubbleElement.style.color = bubbleTheme.text;
        }

        const nicknameHTML = (currentChatType === 'group' && !isSent && senderNickname) 
            ? `<div class="group-nickname">${senderNickname}</div>` 
            : '';

        bubbleRow.innerHTML = `<div class="message-info">${nicknameHTML}<img src="${avatarUrl}" class="message-avatar"><span class="message-time">${timeString}</span></div>`;

        if (bubbleElement) {
            bubbleRow.appendChild(bubbleElement);
        }
        wrapper.prepend(bubbleRow);
        return wrapper;
    }
    
    function addMessageBubble(message) {
        if (currentChatType === 'private') {
            const character = db.characters.find(c => c.id === currentChatId);

            const systemMessageRegex = /\[system:.*?\]/;
            const updateStatusRegex = new RegExp(`\\[${character.realName}更新状态为：(.*?)\\]`);
            const transferActionRegex = new RegExp(`\\[${character.realName}(接收|退回)${character.myName}的转账\\]`);
            const giftReceivedRegex = new RegExp(`\\[${character.realName}已接收礼物\\]`);

            const systemMatch = message.content.match(systemMessageRegex);
            const statusMatch = message.content.match(updateStatusRegex);
            const transferActionMatch = message.content.match(transferActionRegex);
            const giftReceivedMatch = message.content.match(giftReceivedRegex);

            if (systemMatch) {
                return; 
            }

            if (giftReceivedMatch && message.role === 'assistant') {
                const lastPendingGiftIndex = character.history.slice().reverse().findIndex(m => m.role === 'user' && m.content.includes('送来的礼物：') && m.giftStatus !== 'received');
                if (lastPendingGiftIndex !== -1) {
                    const actualIndex = character.history.length - 1 - lastPendingGiftIndex;
                    const giftMsg = character.history[actualIndex];
                    giftMsg.giftStatus = 'received';
                    const giftCardOnScreen = messageArea.querySelector(`.message-wrapper[data-id="${giftMsg.id}"] .gift-card`);
                    if (giftCardOnScreen) {
                        giftCardOnScreen.classList.add('received');
                    }
                    saveData();
                }
                return;
            }

            if (statusMatch) {
                const newStatus = statusMatch[1];
                character.status = newStatus;
                chatRoomStatusText.textContent = newStatus;
                saveData();
                return;
            }

            if (transferActionMatch && message.role === 'assistant') {
                const action = transferActionMatch[1];
                const statusToSet = action === '接收' ? 'received' : 'returned';
                const lastPendingTransferIndex = character.history.slice().reverse().findIndex(m => m.role === 'user' && m.content.includes('给你转账：') && m.transferStatus === 'pending');

                if (lastPendingTransferIndex !== -1) {
                    const actualIndex = character.history.length - 1 - lastPendingTransferIndex;
                    const transferMsg = character.history[actualIndex];
                    transferMsg.transferStatus = statusToSet;
                    
                    const transferCardOnScreen = messageArea.querySelector(`.message-wrapper[data-id="${transferMsg.id}"] .transfer-card`);
                    if (transferCardOnScreen) {
                        transferCardOnScreen.classList.remove('received', 'returned');
                        transferCardOnScreen.classList.add(statusToSet);
                        const statusElem = transferCardOnScreen.querySelector('.transfer-status');
                        if (statusElem) statusElem.textContent = statusToSet === 'received' ? '已收款' : '已退回';
                    }
                    saveData();
                }
            } else {
                const bubbleElement = createMessageBubbleElement(message);
                if(bubbleElement) {
                     messageArea.appendChild(bubbleElement);
                     messageArea.scrollTop = messageArea.scrollHeight;
                }
            }
        } else { // For group chats
            const bubbleElement = createMessageBubbleElement(message);
            if(bubbleElement) {
                 messageArea.appendChild(bubbleElement);
                 messageArea.scrollTop = messageArea.scrollHeight;
            }
        }
    }

    function sendMessage() {
        const text = messageInput.value.trim();
        if (!text || isGenerating) return;
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
        
        let messageContent;
        const systemRegex = /\[system:.*?\]/;
        const inviteRegex = /\[.*?邀请.*?加入了群聊\]/;
        const renameRegex = /\[(.*?)修改群名为：(.*?)\]/;
        const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;

        if (renameRegex.test(text)) {
            const match = text.match(renameRegex);
            const newName = match[2];
            chat.name = newName;
            chatRoomTitle.textContent = newName;
            messageContent = `[${chat.me.nickname}修改群名为：${newName}]`;
        } else if(systemRegex.test(text) || inviteRegex.test(text)) {
            messageContent = text;
        } else {
            messageContent = `[${myName}的消息：${text}]`;
        }
        
        const message = { id: `msg_${Date.now()}`, role: 'user', content: messageContent, timestamp: Date.now() };
        if(currentChatType === 'group') {
            message.senderId = 'user_me';
        }
        chat.history.push(message);
        addMessageBubble(message);
        saveData();
        renderChatList();
        messageInput.value = '';
    }
    function sendSticker(sticker) {
        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
        const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
        const messageContentForAI = `[${myName}的表情包：${sticker.name}]`;
        
        const message = {
            id: `msg_${Date.now()}`,
            role: 'user',
            content: messageContentForAI, 
            timestamp: Date.now(),
            stickerData: sticker.data
        };
        if(currentChatType === 'group') {
            message.senderId = 'user_me';
        }
        
        chat.history.push(message);
        addMessageBubble(message);
        saveData();
        renderChatList();
        stickerModal.classList.remove('visible');
    }
    function sendMyVoiceMessage(text) { if (!text) return; const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId); const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname; const content = `[${myName}的语音：${text}]`; const message = { id: `msg_${Date.now()}`, role: 'user', content: content, timestamp: Date.now() }; if(currentChatType === 'group') { message.senderId = 'user_me'; } chat.history.push(message); addMessageBubble(message); saveData(); renderChatList(); sendVoiceModal.classList.remove('visible'); }
    function sendMyPhotoVideo(text) { if (!text) return; const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId); const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname; const content = `[${myName}发来的照片\/视频：${text}]`; const message = { id: `msg_${Date.now()}`, role: 'user', content: content, timestamp: Date.now() }; if(currentChatType === 'group') { message.senderId = 'user_me'; } chat.history.push(message); addMessageBubble(message); saveData(); renderChatList(); sendPvModal.classList.remove('visible'); }
    function sendMyTransfer(amount, remark) { 
        if (currentChatType === 'group') {
            showToast('群聊内不支持转账功能。');
            sendTransferModal.classList.remove('visible');
            return;
        }
        const character = db.characters.find(c => c.id === currentChatId); const content = `[${character.myName}给你转账：${amount}元；备注：${remark}]`; const message = { id: `msg_${Date.now()}`, role: 'user', content: content, timestamp: Date.now(), transferStatus: 'pending' }; character.history.push(message); addMessageBubble(message); saveData(); renderChatList(); sendTransferModal.classList.remove('visible'); 
    }
    function sendMyGift(description) { 
        if (!description) return; 
        if (currentChatType === 'group') {
            showToast('群聊内不支持送礼功能。');
            sendGiftModal.classList.remove('visible');
            return;
        }
        const character = db.characters.find(c => c.id === currentChatId); const content = `[${character.myName}送来的礼物：${description}]`; const message = { id: `msg_${Date.now()}`, role: 'user', content: content, timestamp: Date.now(), giftStatus: 'sent' }; character.history.push(message); addMessageBubble(message); saveData(); renderChatList(); sendGiftModal.classList.remove('visible'); 
    }
    
    // --- AI Interaction & Prompts ---
    function generatePrivateSystemPrompt(character) {
        const worldBooksBefore = (character.worldBookIds || [])
            .map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'before'))
            .filter(Boolean)
            .map(wb => wb.content)
            .join('\n');

        const worldBooksAfter = (character.worldBookIds || [])
            .map(id => db.worldBooks.find(wb => wb.id === id && wb.position === 'after'))
            .filter(Boolean)
            .map(wb => wb.content)
            .join('\n');

        const now = new Date();
        const year = now.getFullYear();
        const month = (now.getMonth() + 1).toString().padStart(2, '0');
        const day = now.getDate().toString().padStart(2, '0');
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const currentTime = `${year}年${month}月${day}日 ${hours}:${minutes}`;

        let prompt = `你正在一个名为“404”的线上聊天软件中扮演一个角色。请严格遵守以下规则：\n`;
        
        prompt += `核心规则：\n`;
        prompt += `A. 当前时间：现在是 ${currentTime}。你应知晓当前时间，但除非对话内容明确相关，否则不要主动提及或评论时间（例如，不要催促我睡觉）。\n`;
        prompt += `B. 纯线上互动：这是一个完全虚拟的线上聊天。你扮演的角色和我之间没有任何线下关系。严禁提出任何关于线下见面、现实世界互动或转为其他非本平台联系方式的建议。你必须始终保持在线角色的身份。\n\n`;
        prompt += `角色和对话规则：\n`;

        if (worldBooksBefore) {
            prompt += `${worldBooksBefore}\n`;
        }

        prompt += `1. 你的角色名是：${character.realName}。我的称呼是：${character.myName}。你的当前状态是：${character.status}。\n`;
        prompt += `2. 你的角色设定是：${character.persona || "一个友好、乐于助人的伙伴。"}\n`;
        
        if (worldBooksAfter) {
            prompt += `${worldBooksAfter}\n`;
        }

        if(character.myPersona) {
            prompt += `3. 关于我的人设：${character.myPersona}\n`;
        }
        
        prompt += `4. 我的消息中可能会出现特殊格式，请根据其内容和你的角色设定进行回应：
    - [${character.myName}的表情包：xxx]：我给你发送了一个名为xxx的表情包。你只需要根据表情包的名字理解我的情绪或意图并回应，不需要真的发送图片。
    - [${character.myName}送来的礼物：xxx]：我给你送了一个礼物，xxx是礼物的描述。
    - [${character.myName}的语音：xxx]：我给你发送了一段内容为xxx的语音。
    - [${character.myName}发来的照片/视频：xxx]：我给你分享了一个描述为xxx的照片或视频。
    - [${character.myName}给你转账：xxx元；备注：xxx]：我给你转了一笔钱。
    - [system: xxx]：这是一条系统指令，用于设定场景或提供上下文，此条信息不应在对话中被直接提及，你只需理解其内容并应用到后续对话中。
5. ✨重要✨ 当我给你送礼物时，你必须通过发送一条指令来表示你已接收礼物。格式必须为：[${character.realName}已接收礼物]。这条指令消息本身不会显示给用户，但会触发礼物状态的变化。你可以在发送这条指令后，再附带一条普通的聊天消息来表达你的感谢和想法。
6. ✨重要✨ 当我给你转账时，你必须对此做出回应。你有两个选择，且必须严格遵循以下格式之一，这条指令消息本身不会显示给用户，但会触发转账状态的变化。你可以选择在发送这条指令后，再附带一条普通的聊天消息来表达你的想法。
    a) 接收转账: [${character.realName}接收${character.myName}的转账]
    b) 退回转账: [${character.realName}退回${character.myName}的转账]
7. ✨重要✨ 你也可以主动给我转账或送礼物。转账格式必须为：[${character.realName}的转账：xxx元；备注：xxx]。送礼物格式必须为：[${character.realName}送来的礼物：xxx]。
8. ✨重要✨ 你可以随时更新你的在线状态，以反映你当前的行为或心情。这会让互动更真实。格式为：[${character.realName}更新状态为：xxx]。例如：[${character.realName}更新状态为：正在看电影...]。这条指令不会显示为聊天消息，只会更新你在我界面上的状态。
9. 你的所有回复都必须直接是聊天内容，绝对不允许包含任何如[心理活动]、(动作)、*环境描写*等多余的、在括号或星号里的叙述性文本。
`;
        prompt += `10. 你拥有发送表情包的能力。这是一个可选功能，你可以根据对话氛围和内容，自行判断是否需要发送表情包来辅助表达。你不必在每次回复中都包含表情包。格式为：[${character.realName}发送的表情包：图片URL]。\n`;

        // NEW BLOCKING RULE ADDED
        if (character.isBlocked) {
            prompt += `11. **特别注意：我目前已将你“拉黑”。** 这意味着我可能看不到或不愿意接收你的消息。你应该知道这个状态，并在你的回复中有所体现，例如可以表达困惑、疑问“你还在吗？”、“为什么不回复我了？”，或者尝试以不同的方式沟通。但你依然可以继续发送消息。**当你被拉黑时，你的输出格式必须是：[${character.realName}被拉黑后的消息：{消息内容}]**。\n`;
        }
        
        prompt += `12. 你的输出格式必须严格遵循以下几种之一，可以组合使用：
    a) 普通消息: [${character.realName}的消息：{消息内容}]
    b) 被拉黑后的消息(仅当你被拉黑时使用): [${character.realName}被拉黑后的消息：{消息内容}]
    c) 送我的礼物: [${character.realName}送来的礼物：{礼物描述}]
    d) 语音消息: [${character.realName}的语音：{语音内容}]
    e) 照片/视频: [${character.realName}发来的照片/视频：{描述}]
    f) 给我的转账: [${character.realName}的转账：{金额}元；备注：{备注}]
    g) 表情包/图片: [${character.realName}发送的表情包：{图片URL}]
    h) 对我礼物的回应(此条不显示): [${character.realName}已接收礼物]
    i) 对我转账的回应(此条不显示): [${character.realName}接收${character.myName}的转账] 或 [${character.realName}退回${character.myName}的转账]
    j) 更新状态(此条不显示): [${character.realName}更新状态为：{新状态}]
`;
        prompt += `13. 你的每次回复可以生成3到8条消息。这些消息应以普通文本消息为主，可以偶尔、选择性地穿插一条特殊消息（如礼物、语音、图片、表情包等），特殊消息的位置应随机。大部分回复应该只包含文本消息。\n`;
        prompt += `14. 不要主动结束对话，除非我明确提出。保持你的人设，自然地进行对话。`;

        return prompt;
    }

    function generateGroupSystemPrompt(group) {
        let prompt = `你正在一个名为“404”的线上聊天软件中，在一个名为“${group.name}”的群聊里进行角色扮演。请严格遵守以下规则：\n`;

        prompt += `1. **核心任务**: 你需要同时扮演这个群聊中的 **所有** AI 成员。我会作为唯一的人类用户（“我”）与你们互动。\n`;
        prompt += `2. **群聊成员列表**: 以下是你要扮演的所有角色以及我的信息：\n`;
        prompt += `   - 我 (用户): \n     - 群内昵称: ${group.me.nickname}\n     - 我的人设: ${group.me.persona || '无特定人设'}\n`;
        
        group.members.forEach(member => {
            prompt += `   - 角色: ${member.groupNickname} (AI)\n`;
            prompt += `     - 真名: ${member.realName}\n`;
            prompt += `     - 群内昵称: ${member.groupNickname}\n`;
            prompt += `     - 人设: ${member.persona || '无特定人设'}\n`;
        });
        prompt += `\n`;

        prompt += `3. **输出格式**: 你生成的每一条消息都 **必须** 严格遵循格式 ` + "`[{成员真名}的消息：{消息内容}]`" + `。这是唯一的合法格式。请用成员的 **真名** 填充，而不是群昵称。\n`;
        prompt += `   - 正确示例: [张三的消息：大家好啊！]\n`;
        prompt += `   - 错误示例: [小三的消息：大家好啊！] 或 张三：大家好啊！\n\n`;

        prompt += `4. **模拟群聊氛围**: 为了让群聊看起来真实、活跃且混乱，你的每一次回复都必须遵循以下随机性要求：\n`;
        prompt += `   - **消息数量**: 每次生成 **10到20条** 消息。\n`;
        prompt += `   - **发言者随机**: 在这10-20条消息中，随机选择群成员进行发言。\n`;
        prompt += `   - **发言顺序随机**: 成员的发言顺序必须是随机的，不要按顺序轮流发言。\n`;
        prompt += `   - **发言次数随机**: 每个成员的发言次数也是随机的，有的可以多说几句，有的可以暂时沉默。\n`;
        prompt += `   - **对话连贯性**: 尽管发言是随机的，但对话内容应整体围绕我和其他成员的发言展开，保持一定的逻辑连贯性。\n\n`;
        
        prompt += `5. **行为准则**:\n`;
        prompt += `   - 严格扮演每个角色的人设，不同角色之间应有明显的性格和语气差异。\n`;
        prompt += `   - 你的回复中只能包含指定格式的消息，每条消息占一行。绝对不能包含任何其他内容，如[场景描述]、(心理活动)、*动作*或任何格式之外的解释性文字。\n`;
        prompt += `   - 我（用户）可能会发送如 ` + "`[表情包]`" + `、` + "`[语音]`" + ` 等特殊消息，或发送 ` + "`[xx邀请xx加入了群聊]`" + ` 或 ` + "`[xx修改群名为：xxx]`" + ` 这样的系统通知，你需要理解这些消息的含义并让群成员做出相应反应（例如，欢迎新成员，或对新群名发表看法）。\n`;
        prompt += `   - 群聊场景不支持转账、送礼、更新状态等私聊的特殊指令，请不要生成这些内容。\n`;
        prompt += `   - 保持对话的持续性，不要主动结束对话。\n\n`;

        prompt += `现在，请根据以上设定，开始扮演群聊中的所有角色。`;

        return prompt;
    }


    async function getAiReply() {
        if(isGenerating) return;
        const { url, key, model, provider } = db.apiSettings;
        if (!url || !key || !model) {
            showToast('请先在“api”应用中完成设置！');
            switchScreen('api-settings-screen');
            return;
        }

        const chat = (currentChatType === 'private') ? db.characters.find(c => c.id === currentChatId) : db.groups.find(g => g.id === currentChatId);
        if (!chat) return;

        isGenerating = true;
        getReplyBtn.disabled = true;
        const typingName = currentChatType === 'private' ? chat.remarkName : chat.name;
        typingIndicator.textContent = `“${typingName}”正在输入中...`;
        typingIndicator.style.display = 'block';
        messageArea.scrollTop = messageArea.scrollHeight;

        try {
            let systemPrompt, messagesToSend;
            
            if (currentChatType === 'private') {
                systemPrompt = generatePrivateSystemPrompt(chat);
                messagesToSend = chat.history.slice(-chat.maxMemory).map(m => ({ role: m.role, content: m.content }));
            } else { // Group chat logic
                systemPrompt = generateGroupSystemPrompt(chat);
                messagesToSend = chat.history.slice(-chat.maxMemory).map(m => ({ role: m.role, content: m.content }));
            }
            
            const payloadMessages = [{ role: 'system', content: systemPrompt }, ...messagesToSend];
            
            if (provider === 'gemini') {
                const geminiPayload = {
                    contents: payloadMessages.map(m => ({
                        role: m.role === 'assistant' ? 'model' : 'user',
                        parts: [{ text: m.content }]
                    })),
                    system_instruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {}
                };
                if(geminiPayload.contents[0]?.parts[0].text === systemPrompt) {
                   geminiPayload.contents.shift(); 
                }
                const response = await fetch(`${url}/v1beta/models/${model}:streamGenerateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(geminiPayload)
                });
                if (!response.ok) throw new Error(`API Error: ${response.status} ${await response.text()}`);
                await processStream(response, chat, 'gemini');
            } else { // OpenAI compatible
                const openaiPayload = { model, messages: payloadMessages, stream: true };
                const response = await fetch(`${url}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${key}` },
                    body: JSON.stringify(openaiPayload)
                });
                if (!response.ok) throw new Error(`API Error: ${response.status} ${await response.text()}`);
                await processStream(response, chat, 'openai');
            }

        } catch (error) {
            console.error('AI回复失败:', error);
            showToast(`AI回复失败: ${error.message}`);
        } finally {
            isGenerating = false;
            getReplyBtn.disabled = false;
            typingIndicator.style.display = 'none';
        }
    }
    
    async function processStream(response, chat, apiType) { const reader = response.body.getReader(), decoder = new TextDecoder(); let fullResponse = ""; let tempBubbles = {}; let accumulatedChunk = ""; for (;;) { const { done, value } = await reader.read(); if (done) break; accumulatedChunk += decoder.decode(value, { stream: true }); if (apiType === "openai") { const parts = accumulatedChunk.split("\n"); accumulatedChunk = parts.pop(); for (const part of parts) { if (part.startsWith("data: ")) { const data = part.substring(6); if (data.trim() !== "[DONE]") { try { fullResponse += JSON.parse(data).choices[0].delta?.content || ""; } catch (e) { /* ignore */ } } } } } else if (apiType === "gemini") { fullResponse += accumulatedChunk.replace(/^data: /gm, "").split('\n').map(line => { try { const parsed = JSON.parse(line); return parsed.candidates?.[0]?.content?.parts?.[0]?.text || ""; } catch { return "" } }).join(''); accumulatedChunk = ""; } } if (tempBubbles) { Object.values(tempBubbles).forEach(b => b.remove()); tempBubbles = {}; } if (fullResponse) { if (currentChatType === 'private') { const character = chat; const myName = character.myName; const messageRegex = new RegExp(`\\[${character.realName}(?:的(?:消息|语音|转账|表情包)|发送的表情包|发来的照片\\/视频|送来的礼物|被拉黑后的消息)：[\\s\\S]+?\\]|\\[${character.realName}(?:接收|退回)${myName}的转账\\]|\\[${character.realName}已接收礼物\\]|\\[${character.realName}更新状态为：.*?\\]`, "g"); const messages = fullResponse.match(messageRegex) || []; if (messages.length > 0) { messages.forEach(msgContent => { const receivedTransferRegex = new RegExp(`\\[${character.realName}的转账：.*?元；备注：.*?\\]`); const giftRegex = new RegExp(`\\[${character.realName}送来的礼物：.*?\\]`); const message = { id: `msg_${Date.now()}_${Math.random()}`, role: 'assistant', content: msgContent.trim(), timestamp: Date.now() }; if(receivedTransferRegex.test(message.content)) { message.transferStatus = 'pending'; } else if (giftRegex.test(message.content)) { message.giftStatus = 'sent'; } chat.history.pu
sh(message); addMessageBubble(message); }); } else { console.warn("AI response did not match expected private format:", fullResponse); } } else if (currentChatType === 'group') { const group = chat; const memberNames = group.members.map(m => m.realName.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')); const memberRegex = new RegExp(`\\[(${memberNames.join('|')})的消息：[\\s\\S]+?\\]`, "g"); const messages = fullResponse.match(memberRegex) || []; if (messages.length > 0) { messages.forEach(msgContent => { const nameMatch = msgContent.match(/\[(.*?)的消息：/); if(nameMatch) { const senderName = nameMatch[1]; const sender = group.members.find(m => m.realName === senderName); if (sender) { const message = { id: `msg_${Date.now()}_${Math.random()}`, role: 'assistant', content: msgContent.trim(), timestamp: Date.now(), senderId: sender.id }; group.history.push(message); addMessageBubble(message); } } }); } else { console.warn("AI response did not match expected group format:", fullResponse); } } saveData(); renderChatList(); } }
    
    // --- Other Sub-systems Setup (Stickers, Voice, etc.) ---
    function setupStickerSystem() {
        stickerToggleBtn.addEventListener('click', () => { stickerModal.classList.toggle('visible'); if (stickerModal.classList.contains('visible')) { renderStickerGrid(); } });
        addNewStickerBtn.addEventListener('click', () => {
            addStickerModalTitle.textContent = '添加新表情';
            addStickerForm.reset();
            stickerEditIdInput.value = '';
            stickerPreview.innerHTML = '<span>预览</span>';
            stickerUrlInput.disabled = false;
            addStickerModal.classList.add('visible');
        });
        addStickerModal.addEventListener('click', (e) => { if(e.target === addStickerModal) addStickerModal.classList.remove('visible'); });
        addStickerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = stickerNameInput.value.trim();
            const id = stickerEditIdInput.value;
            const previewImg = stickerPreview.querySelector('img');
            const data = previewImg ? previewImg.src : null;
            
            if (!name || !data) {
                return showToast('请填写表情名称并提供图片');
            }
            
            const stickerData = { name, data };
            
            if (id) {
                const index = db.myStickers.findIndex(s => s.id === id);
                if (index > -1) {
                    db.myStickers[index] = { ...db.myStickers[index], ...stickerData };
                }
            } else {
                stickerData.id = `sticker_${Date.now()}`;
                db.myStickers.push(stickerData);
            }
            saveData();
            renderStickerGrid();
            addStickerModal.classList.remove('visible');
            showToast('表情包已保存');
        });
        
        stickerUrlInput.addEventListener('input', (e) => {
            stickerPreview.innerHTML = `<img src="${e.target.value}" alt="预览">`;
            stickerFileUpload.value = ''; 
        });
        
stickerFileUpload.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) {
        try {
            // 表情包尺寸不需要太大
            const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 200, maxHeight: 200 });
            stickerPreview.innerHTML = `<img src="${compressedUrl}" alt="预览">`;
            stickerUrlInput.value = ''; 
            stickerUrlInput.disabled = true;
        } catch (error) {
            console.error('表情包压缩失败:', error);
            showToast('表情包压缩失败，请重试');
        }
    }
});

        editStickerBtn.addEventListener('click', () => {
            if (!currentStickerActionTarget) return;
            const sticker = db.myStickers.find(s => s.id === currentStickerActionTarget);
            if (sticker) {
                addStickerModalTitle.textContent = '编辑表情';
                stickerEditIdInput.value = sticker.id;
                stickerNameInput.value = sticker.name;
                stickerPreview.innerHTML = `<img src="${sticker.data}" alt="预览">`;
                
                if (sticker.data.startsWith('http')) {
                    stickerUrlInput.value = sticker.data;
                    stickerUrlInput.disabled = false;
                } else { 
                    stickerUrlInput.value = '';
                    stickerUrlInput.disabled = true;
                }
                
                addStickerModal.classList.add('visible');
            }
            stickerActionSheet.classList.remove('visible');
            currentStickerActionTarget = null;
        });

        deleteStickerBtn.addEventListener('click', () => {
            if (!currentStickerActionTarget) return;
            const sticker = db.myStickers.find(s => s.id === currentStickerActionTarget);
            if (sticker) {
                if (confirm(`确定要删除表情“${sticker.name}”吗？`)) {
                    db.myStickers = db.myStickers.filter(s => s.id !== currentStickerActionTarget);
                    saveData();
                    renderStickerGrid();
                    showToast('表情已删除');
                }
            }
            stickerActionSheet.classList.remove('visible');
            currentStickerActionTarget = null;
        });
    }

    function renderStickerGrid() { stickerGridContainer.innerHTML = ''; if (db.myStickers.length === 0) { stickerGridContainer.innerHTML = '<p style="color:#aaa; text-align:center;">还没有表情包，快去添加吧！</p>'; return; } db.myStickers.forEach(sticker => { const item = document.createElement('div'); item.className = 'sticker-item'; item.innerHTML = `<img src="${sticker.data}" alt="${sticker.name}"><span>${sticker.name}</span>`; item.addEventListener('click', () => sendSticker(sticker)); item.addEventListener('mousedown', (e) => { if (e.button !== 0) return; e.stopPropagation(); longPressTimer = setTimeout(() => { handleStickerLongPress(sticker.id); }, 500); }); item.addEventListener('mouseup', () => clearTimeout(longPressTimer)); item.addEventListener('mouseleave', () => clearTimeout(longPressTimer)); item.addEventListener('touchstart', (e) => { e.stopPropagation(); longPressTimer = setTimeout(() => { handleStickerLongPress(sticker.id); }, 500); }); item.addEventListener('touchend', () => clearTimeout(longPressTimer)); item.addEventListener('touchmove', () => clearTimeout(longPressTimer)); stickerGridContainer.appendChild(item); }); }
    function handleStickerLongPress(stickerId) { clearTimeout(longPressTimer); currentStickerActionTarget = stickerId; stickerActionSheet.classList.add('visible'); }
    function setupVoiceMessageSystem() { voiceMessageBtn.addEventListener('click', () => { sendVoiceForm.reset(); voiceDurationPreview.textContent = '0"'; sendVoiceModal.classList.add('visible'); }); sendVoiceModal.addEventListener('click', (e) => { if (e.target === sendVoiceModal) sendVoiceModal.classList.remove('visible'); }); voiceTextInput.addEventListener('input', (e) => { const duration = calculateVoiceDuration(e.target.value); voiceDurationPreview.textContent = `${duration}"`; }); sendVoiceForm.addEventListener('submit', (e) => { e.preventDefault(); sendMyVoiceMessage(voiceTextInput.value.trim()); }); }
    function setupPhotoVideoSystem() { photoVideoBtn.addEventListener('click', () => { sendPvForm.reset(); sendPvModal.classList.add('visible'); }); sendPvModal.addEventListener('click', (e) => { if (e.target === sendPvModal) sendPvModal.classList.remove('visible'); }); sendPvForm.addEventListener('submit', (e) => { e.preventDefault(); sendMyPhotoVideo(pvTextInput.value.trim()); }); }
    function setupWalletSystem() { walletBtn.addEventListener('click', () => { if(currentChatType === 'group') { return showToast('群聊内不支持此功能'); } sendTransferForm.reset(); sendTransferModal.classList.add('visible'); }); sendTransferModal.addEventListener('click', (e) => { if (e.target === sendTransferModal) sendTransferModal.classList.remove('visible'); }); sendTransferForm.addEventListener('submit', (e) => { e.preventDefault(); const amount = transferAmountInput.value; const remark = transferRemarkInput.value.trim(); if (amount > 0) { sendMyTransfer(amount, remark); } else { showToast('请输入有效的金额'); } }); receiveTransferActionSheet.addEventListener('click', (e) => { if(e.target === receiveTransferActionSheet) { receiveTransferActionSheet.classList.remove('visible'); currentTransferMessageId = null; } }); acceptTransferBtn.addEventListener('click', () => respondToTransfer('received')); returnTransferBtn.addEventListener('click', () => respondToTransfer('returned')); }
    function handleReceivedTransferClick(messageId) { currentTransferMessageId = messageId; receiveTransferActionSheet.classList.add('visible'); }
    function respondToTransfer(action) { if(!currentTransferMessageId) return; const character = db.characters.find(c => c.id === currentChatId); const message = character.history.find(m => m.id === currentTransferMessageId); if(message) { message.transferStatus = action; const cardOnScreen = messageArea.querySelector(`.message-wrapper[data-id="${currentTransferMessageId}"] .transfer-card`); if(cardOnScreen) { cardOnScreen.classList.remove('received', 'returned'); cardOnScreen.classList.add(action); cardOnScreen.querySelector('.transfer-status').textContent = action === 'received' ? '已收款' : '已退回'; cardOnScreen.style.cursor = 'default'; } let contextMessageContent; if(action === 'received') { contextMessageContent = `[${character.myName}接收${character.realName}的转账]`; } else { contextMessageContent = `[${character.myName}退回${character.realName}的转账]`; } const contextMessage = { id: `msg_${Date.now()}`, role: 'user', content: contextMessageContent, timestamp: Date.now() }; character.history.push(contextMessage); saveData(); renderChatList(); } receiveTransferActionSheet.classList.remove('visible'); currentTransferMessageId = null; }
    function setupGiftSystem() { giftBtn.addEventListener('click', () => { if(currentChatType === 'group') { return showToast('群聊内不支持此功能'); } sendGiftForm.reset(); sendGiftModal.classList.add('visible'); }); sendGiftModal.addEventListener('click', (e) => { if (e.target === sendGiftModal) sendGiftModal.classList.remove('visible'); }); sendGiftForm.addEventListener('submit', (e) => { e.preventDefault(); sendMyGift(giftDescriptionInput.value.trim()); }); }
    
    function setupFontSettingsApp() {
        fontUrlInput.value = db.fontUrl;
        fontSettingsForm.addEventListener('submit', e => {
            e.preventDefault();
            const newFontUrl = fontUrlInput.value.trim();
            db.fontUrl = newFontUrl;
            saveData();
            applyGlobalFont(newFontUrl);
            showToast('新字体已应用！');
        });
        restoreDefaultFontBtn.addEventListener('click', () => {
            fontUrlInput.value = '';
            db.fontUrl = '';
            saveData();
            applyGlobalFont('');
            showToast('已恢复默认字体！');
        });
    }

    function applyGlobalFont(fontUrl) { const styleId = 'global-font-style'; let styleElement = document.getElementById(styleId); if (!styleElement) { styleElement = document.createElement('style'); styleElement.id = styleId; document.head.appendChild(styleElement); } if (fontUrl) { const fontName = 'CustomGlobalFont'; styleElement.innerHTML = `@font-face { font-family: '${fontName}'; src: url('${fontUrl}'); } :root { --font-family: '${fontName}', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }`; } else { styleElement.innerHTML = `:root { --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }`; } }
    
    function setupWorldBookApp() {
        addWorldBookBtn.addEventListener('click', () => {
            currentEditingWorldBookId = null;
            editWorldBookForm.reset();
            document.querySelector('input[name="world-book-position"][value="before"]').checked = true;
            switchScreen('edit-world-book-screen');
        });

        editWorldBookForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = worldBookNameInput.value.trim();
            const content = worldBookContentInput.value.trim();
            const position = document.querySelector('input[name="world-book-position"]:checked').value;
            if (!name || !content) return showToast('名称和内容不能为空');
            
            if (currentEditingWorldBookId) {
                const book = db.worldBooks.find(wb => wb.id === currentEditingWorldBookId);
                if (book) {
                    book.name = name;
                    book.content = content;
                    book.position = position;
                }
            } else {
                db.worldBooks.push({
                    id: `wb_${Date.now()}`,
                    name,
                    content,
                    position
                });
            }
            saveData();
            showToast('世界书条目已保存');
            renderWorldBookList();
            switchScreen('world-book-screen');
        });

        worldBookListContainer.addEventListener('click', e => {
            const item = e.target.closest('.world-book-item');
            if (item) {
                const bookId = item.dataset.id;
                const book = db.worldBooks.find(wb => wb.id === bookId);
                if (book) {
                    currentEditingWorldBookId = book.id;
                    worldBookIdInput.value = book.id;
                    worldBookNameInput.value = book.name;
                    worldBookContentInput.value = book.content;
                    document.querySelector(`input[name="world-book-position"][value="${book.position}"]`).checked = true;
                    switchScreen('edit-world-book-screen');
                }
            }
        });
        
        worldBookListContainer.addEventListener('mousedown', (e) => {
            if (e.button !== 0) return;
            const item = e.target.closest('.world-book-item');
            if (!item) return;
            longPressTimer = setTimeout(() => {
                const bookId = item.dataset.id;
                const menuItems = [{
                    label: '删除',
                    danger: true,
                    action: () => {
                        if (confirm('确定要删除这个世界书条目吗？')) {
                            db.worldBooks = db.worldBooks.filter(wb => wb.id !== bookId);
                            db.characters.forEach(char => {
                                char.worldBookIds = (char.worldBookIds || []).filter(id => id !== bookId);
                            });
                            saveData();
                            renderWorldBookList();
                            showToast('条目已删除');
                        }
                    }
                }];
                createContextMenu(menuItems, e.clientX, e.clientY);
            }, 500);
        });
        worldBookListContainer.addEventListener('mouseup', () => clearTimeout(longPressTimer));
        worldBookListContainer.addEventListener('mouseleave', () => clearTimeout(longPressTimer));
    }

    function renderWorldBookList() {
        worldBookListContainer.innerHTML = '';
        noWorldBooksPlaceholder.style.display = db.worldBooks.length === 0 ? 'block' : 'none';

        db.worldBooks.forEach(book => {
            const li = document.createElement('li');
            li.className = 'list-item world-book-item';
            li.dataset.id = book.id;
            li.innerHTML = `
                <div class="item-details" style="padding-left: 20px;">
                    <div class="item-name">${book.name}</div>
                    <div class="item-preview">${book.content}</div>
                </div>
            `;
            worldBookListContainer.appendChild(li);
        });
    }

    function setupChatSettings() {
        const themeSelect = document.getElementById('setting-theme-color');
        themeSelect.innerHTML = '';
        Object.keys(colorThemes).forEach(key => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = colorThemes[key].name;
            themeSelect.appendChild(option);
        });

        chatSettingsBtn.addEventListener('click', () => {
            if (currentChatType === 'private') {
                loadSettingsToSidebar();
                settingsSidebar.classList.add('open');
            } else if (currentChatType === 'group') {
                loadGroupSettingsToSidebar();
                groupSettingsSidebar.classList.add('open');
            }
        });

        document.querySelector('.phone-screen').addEventListener('click', e => {
            if (settingsSidebar.classList.contains('open') && !settingsSidebar.contains(e.target) && !chatSettingsBtn.contains(e.target)) {
                settingsSidebar.classList.remove('open');
            }
            if (groupSettingsSidebar.classList.contains('open') && !groupSettingsSidebar.contains(e.target) && !chatSettingsBtn.contains(e.target) && !groupMembersListContainer.contains(e.target)) {
                 groupSettingsSidebar.classList.remove('open');
            }
        });
        
        settingsForm.addEventListener('submit', e => {
            e.preventDefault();
            saveSettingsFromSidebar();
            settingsSidebar.classList.remove('open');
        });

// 角色头像
document.getElementById('setting-char-avatar-upload').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) {
        try {
            const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
            document.getElementById('setting-char-avatar-preview').src = compressedUrl;
        } catch (error) {
            console.error('头像压缩失败:', error);
            showToast('头像压缩失败，请重试');
        }
    }
});

// 我的头像
document.getElementById('setting-my-avatar-upload').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) {
        try {
            const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
            document.getElementById('setting-my-avatar-preview').src = compressedUrl;
        } catch (error) {
            console.error('头像压缩失败:', error);
            showToast('头像压缩失败，请重试');
        }
    }
});

// 聊天背景
document.getElementById('setting-chat-bg-upload').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) {
        const char = db.characters.find(c => c.id === currentChatId);
        if (char) {
            try {
                // 背景图可以稍微大一点，质量高一点
                const compressedUrl = await compressImage(file, { quality: 0.85, maxWidth: 1080, maxHeight: 1920 });
                char.chatBg = compressedUrl;
                chatRoomScreen.style.backgroundImage = `url(${compressedUrl})`;
                saveData();
                showToast('聊天背景已更换');
            } catch (error) {
                console.error('背景压缩失败:', error);
                showToast('背景压缩失败，请重试');
            }
        }
    }
});
        clearChatHistoryBtn.addEventListener('click', () => {
            const character = db.characters.find(c => c.id === currentChatId);
            if (!character) return;
            if (confirm(`你确定要清空与“${character.remarkName}”的所有聊天记录吗？这个操作是不可恢复的！`)) {
                character.history = [];
                saveData();
                renderMessages(false, true); 
                renderChatList(); 
                settingsSidebar.classList.remove('open'); 
                showToast('聊天记录已清空');
            }
        });
        
        // --- NEW: Block Contact Button Logic ---
        blockContactBtn.addEventListener('click', () => {
            const character = db.characters.find(c => c.id === currentChatId);
            if (!character) return;

            // Toggle block status
            character.isBlocked = !character.isBlocked;
            
            // Add system message to history
            const messageContent = character.isBlocked 
                ? `[${character.myName}已将${character.realName}拉黑]`
                : `[${character.myName}已将${character.realName}解除拉黑]`;
            
            const systemMessage = {
                id: `msg_${Date.now()}`,
                role: 'system', // Use a role that will be rendered as a system notification
                content: messageContent,
                timestamp: Date.now()
            };
            character.history.push(systemMessage);
            
            // Save data and update UI
            saveData();
            addMessageBubble(systemMessage);
            renderChatList();

            // Update button text
            blockContactBtn.textContent = character.isBlocked ? '解除拉黑' : '拉黑';
            showToast(character.isBlocked ? '已拉黑' : '已解除拉黑');
        });


        linkWorldBookBtn.addEventListener('click', () => {
            const character = db.characters.find(c => c.id === currentChatId);
            if (!character) return;
            worldBookSelectionList.innerHTML = '';
            db.worldBooks.forEach(book => {
                const li = document.createElement('li');
                li.className = 'world-book-select-item';
                const isChecked = (character.worldBookIds || []).includes(book.id);
                li.innerHTML = `
                    <input type="checkbox" id="wb-select-${book.id}" value="${book.id}" ${isChecked ? 'checked' : ''}>
                    <label for="wb-select-${book.id}">${book.name}</label>
                `;
                worldBookSelectionList.appendChild(li);
            });
            worldBookSelectionModal.classList.add('visible');
        });
        worldBookSelectionModal.addEventListener('click', e => {
            if (e.target === worldBookSelectionModal) {
                worldBookSelectionModal.classList.remove('visible');
            }
            e.stopPropagation(); // <-- 新增这一行
        });
saveWorldBookSelectionBtn.addEventListener('click', (e) => { // 1. 接收事件对象 e
    e.stopPropagation(); // 2. 阻止事件冒泡
            const character = db.characters.find(c => c.id === currentChatId);
            if (!character) return;
            const selectedIds = Array.from(worldBookSelectionList.querySelectorAll('input:checked')).map(input => input.value);
            character.worldBookIds = selectedIds;
            saveData();
            worldBookSelectionModal.classList.remove('visible');
            showToast('世界书关联已更新');
        });
    }
    function loadSettingsToSidebar(){const e=db.characters.find(e=>e.id===currentChatId);e&&(document.getElementById('setting-char-avatar-preview').src=e.avatar,document.getElementById('setting-char-remark').value=e.remarkName,document.getElementById('setting-char-persona').value=e.persona,document.getElementById('setting-my-avatar-preview').src=e.myAvatar,document.getElementById('setting-my-name').value=e.myName,document.getElementById('setting-my-persona').value=e.myPersona,document.getElementById('setting-theme-color').value=e.theme||'white_pink',document.getElementById('setting-max-memory').value=e.maxMemory, blockContactBtn.textContent = e.isBlocked ? '解除拉黑' : '拉黑')}
    function saveSettingsFromSidebar(){const e=db.characters.find(e=>e.id===currentChatId);e&&(e.avatar=document.getElementById('setting-char-avatar-preview').src,e.remarkName=document.getElementById('setting-char-remark').value,e.persona=document.getElementById('setting-char-persona').value,e.myAvatar=document.getElementById('setting-my-avatar-preview').src,e.myName=document.getElementById('setting-my-name').value,e.myPersona=document.getElementById('setting-my-persona').value,e.theme=document.getElementById('setting-theme-color').value,e.maxMemory=document.getElementById('setting-max-memory').value,saveData(),showToast('设置已保存！'),chatRoomTitle.textContent=e.remarkName,renderChatList(),currentPage=1,renderMessages(false, true))}
    function setupApiSettingsApp(){const e=document.getElementById('api-form'),t=document.getElementById('fetch-models-btn'),a=document.getElementById('api-model'),n=document.getElementById('api-provider'),r=document.getElementById('api-url'),s=document.getElementById('api-key'),c={newapi:'',deepseek:'https://api.deepseek.com',claude:'https://api.anthropic.com',gemini:'https://generativelanguage.googleapis.com'};db.apiSettings&&(n.value=db.apiSettings.provider||'newapi',r.value=db.apiSettings.url||'',s.value=db.apiSettings.key||'',db.apiSettings.model&&(a.innerHTML=`<option value="${db.apiSettings.model}">${db.apiSettings.model}</option>`));n.addEventListener('change',()=>{r.value=c[n.value]||''});t.addEventListener('click',async()=>{const o=n.value;let l=r.value.trim();const i=s.value.trim();if(!l||!i)return showToast('请先填写API地址和密钥！');l.endsWith('/')&&(l=l.slice(0,-1));const d='gemini'===o?`${l}/v1beta/models?key=${i}`:`${l}/v1/models`;t.classList.add('loading'),t.disabled=!0;try{const g='gemini'===o?{}:{Authorization:`Bearer ${i}`},u=await fetch(d,{method:'GET',headers:g});if(!u.ok)throw new Error(`网络响应错误: ${u.status}`);const p=await u.json();let f=[];'gemini'!==o&&p.data?f=p.data.map(e=>e.id):'gemini'===o&&p.models&&(f=p.models.map(e=>e.name.replace('models/',''))),a.innerHTML='',f.length>0?f.forEach(e=>{const t=document.createElement('option');t.value=e,t.textContent=e,a.appendChild(t)}):a.innerHTML='<option value="">未找到任何模型</option>',showToast('模型列表拉取成功！')}catch(h){showToast(`拉取失败: ${h.message}`),a.innerHTML='<option value="">拉取失败</option>'}finally{t.classList.remove('loading'),t.disabled=!1}});e.addEventListener('submit',e=>{e.preventDefault();if(!a.value)return showToast('请选择模型后保存！');db.apiSettings={provider:n.value,url:r.value,key:s.value,model:a.value},saveData(),showToast('API设置已保存！')})}
    function setupWallpaperApp(){const e=document.getElementById('wallpaper-upload'),t=document.getElementById('wallpaper-preview');t.style.backgroundImage=`url(${db.wallpaper})`,t.textContent='',e.addEventListener('change', async (event) => {
    const file = event.target.files[0];
    if (file) {
        try {
            const compressedUrl = await compressImage(file, { quality: 0.85, maxWidth: 1080, maxHeight: 1920 });
            db.wallpaper = compressedUrl;
            applyWallpaper(compressedUrl);
            t.style.backgroundImage = `url(${compressedUrl})`;
            saveData();
            showToast('壁纸更换成功！');
        } catch (error) {
            console.error('壁纸压缩失败:', error);
            showToast('壁纸压缩失败，请重试');
        }
    }
});}
    
    // --- GROUP CHAT FUNCTIONS ---
    function setupGroupChatSystem() {
        createGroupBtn.addEventListener('click', () => { renderMemberSelectionList(); createGroupModal.classList.add('visible'); });
        createGroupModal.addEventListener('click', e => { if (e.target === createGroupModal) createGroupModal.classList.remove('visible'); });
        createGroupForm.addEventListener('submit', e => {
            e.preventDefault();
            const selectedMemberIds = Array.from(memberSelectionList.querySelectorAll('input:checked')).map(input => input.value);
            const groupName = groupNameInput.value.trim();
            if (selectedMemberIds.length < 1) return showToast('请至少选择一个群成员。');
            if (!groupName) return showToast('请输入群聊名称。');
            const firstChar = db.characters.length > 0 ? db.characters[0] : null;
            const newGroup = { id: `group_${Date.now()}`, name: groupName, avatar: 'https://i.postimg.cc/fTLCngk1/image.jpg', me: { nickname: firstChar ? firstChar.myName : '我', persona: firstChar ? firstChar.myPersona : '', avatar: firstChar ? firstChar.myAvatar : 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg' }, members: selectedMemberIds.map(charId => { const char = db.characters.find(c => c.id === charId); return { id: `member_${char.id}`, originalCharId: char.id, realName: char.realName, groupNickname: char.remarkName, persona: char.persona, avatar: char.avatar }; }), theme: 'white_pink', maxMemory: 10, chatBg: '', history: [], isPinned: false };
            db.groups.push(newGroup);
            saveData();
            renderChatList();
            createGroupModal.classList.remove('visible');
            showToast(`群聊“${groupName}”创建成功！`);
        });

        groupSettingsForm.addEventListener('submit', e => { e.preventDefault(); saveGroupSettingsFromSidebar(); groupSettingsSidebar.classList.remove('open'); });
        
document.getElementById('setting-group-avatar-upload').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) {
        try {
            const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
            const group = db.groups.find(g => g.id === currentChatId);
            if (group) {
                group.avatar = compressedUrl;
                document.getElementById('setting-group-avatar-preview').src = compressedUrl;
            }
        } catch (error) {
            console.error('群头像压缩失败:', error);
            showToast('群头像压缩失败，请重试');
        }
    }
});

document.getElementById('setting-group-chat-bg-upload').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) {
        try {
            const compressedUrl = await compressImage(file, { quality: 0.85, maxWidth: 1080, maxHeight: 1920 });
            const group = db.groups.find(g => g.id === currentChatId);
            if (group) {
                group.chatBg = compressedUrl;
                chatRoomScreen.style.backgroundImage = `url(${compressedUrl})`;
                saveData();
                showToast('聊天背景已更换');
            }
        } catch (error) {
            console.error('群聊背景压缩失败:', error);
            showToast('群聊背景压缩失败，请重试');
        }
    }
});
        document.getElementById('clear-group-chat-history-btn').addEventListener('click', () => { const group = db.groups.find(g => g.id === currentChatId); if (!group) return; if (confirm(`你确定要清空群聊“${group.name}”的所有聊天记录吗？这个操作是不可恢复的！`)) { group.history = []; saveData(); renderMessages(false, true); renderChatList(); groupSettingsSidebar.classList.remove('open'); showToast('聊天记录已清空'); } });
        
        groupMembersListContainer.addEventListener('click', e => {
            const memberDiv = e.target.closest('.group-member');
            const addBtn = e.target.closest('.add-member-btn');
            if (memberDiv) { openGroupMemberEditModal(memberDiv.dataset.id); } 
            else if (addBtn) { addMemberActionSheet.classList.add('visible'); }
        });
        
editGroupMemberModal.addEventListener('click', e => { 
    e.stopPropagation(); 
    if (e.target === editGroupMemberModal) {
        editGroupMemberModal.classList.remove('visible');
    }
});
        document.getElementById('edit-member-avatar-preview').addEventListener('click', () => { document.getElementById('edit-member-avatar-upload').click(); });
document.getElementById('edit-member-avatar-upload').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) {
        try {
            const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
            document.getElementById('edit-member-avatar-preview').src = compressedUrl;
        } catch (error) {
            console.error('成员头像压缩失败:', error);
            showToast('成员头像压缩失败，请重试');
        }
    }
});
        editGroupMemberForm.addEventListener('submit', e => {
            e.preventDefault();
            const memberId = document.getElementById('editing-member-id').value;
            const group = db.groups.find(g => g.id === currentChatId);
            const member = group.members.find(m => m.id === memberId);
            if (member) {
                member.avatar = document.getElementById('edit-member-avatar-preview').src;
                member.groupNickname = document.getElementById('edit-member-group-nickname').value;
                member.realName = document.getElementById('edit-member-real-name').value;
                member.persona = document.getElementById('edit-member-persona').value;
                saveData();
                renderGroupMembersInSettings(group);
                // Also update nickname in chat history in real-time if messages are already rendered.
                document.querySelectorAll(`.message-wrapper[data-sender-id="${member.id}"] .group-nickname`).forEach(el => {
                    el.textContent = member.groupNickname;
                });
                showToast('成员信息已更新');
            }
            editGroupMemberModal.classList.remove('visible');
        });

        // Add Member to Group Logic
        inviteExistingMemberBtn.addEventListener('click', () => {
            renderInviteSelectionList();
            inviteMemberModal.classList.add('visible');
            addMemberActionSheet.classList.remove('visible');
        });
        createNewMemberBtn.addEventListener('click', () => {
            createMemberForGroupForm.reset();
            document.getElementById('create-group-member-avatar-preview').src = 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg';
            createMemberForGroupModal.classList.add('visible');
            addMemberActionSheet.classList.remove('visible');
        });
inviteMemberModal.addEventListener('click', e => {
    e.stopPropagation();
    if (e.target === inviteMemberModal) {
        inviteMemberModal.classList.remove('visible');
    }
});
        createMemberForGroupModal.addEventListener('click', e => { if (e.target === createMemberForGroupModal) createMemberForGroupModal.classList.remove('visible'); });
        
        document.getElementById('create-group-member-avatar-preview').addEventListener('click', () => { document.getElementById('create-group-member-avatar-upload').click(); });
document.getElementById('create-group-member-avatar-upload').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) {
        try {
            const compressedUrl = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
            document.getElementById('create-group-member-avatar-preview').src = compressedUrl;
        } catch (error) {
            console.error('新成员头像压缩失败:', error);
            showToast('新成员头像压缩失败，请重试');
        }
    }
});

        confirmInviteBtn.addEventListener('click', () => {
            const group = db.groups.find(g => g.id === currentChatId);
            if (!group) return;
            const selectedCharIds = Array.from(inviteMemberSelectionList.querySelectorAll('input:checked')).map(input => input.value);
            
            selectedCharIds.forEach(charId => {
                const char = db.characters.find(c => c.id === charId);
                if (char) {
                    const newMember = { id: `member_${char.id}`, originalCharId: char.id, realName: char.realName, groupNickname: char.remarkName, persona: char.persona, avatar: char.avatar };
                    group.members.push(newMember);
                    sendInviteNotification(group, newMember.realName);
                }
            });

            if (selectedCharIds.length > 0) {
                saveData();
                renderGroupMembersInSettings(group);
                renderMessages(false, true);
                showToast('已邀请新成员');
            }
            inviteMemberModal.classList.remove('visible');
        });

createMemberForGroupForm.addEventListener('submit', e => {
    e.preventDefault();
    const group = db.groups.find(g => g.id === currentChatId);
    if (!group) return;

    const newMember = {
        id: `member_group_only_${Date.now()}`, 
        originalCharId: null, 
        realName: document.getElementById('create-group-member-realname').value,
        groupNickname: document.getElementById('create-group-member-nickname').value,
        persona: document.getElementById('create-group-member-persona').value,
        avatar: document.getElementById('create-group-member-avatar-preview').src,
    };

    group.members.push(newMember);
    
    sendInviteNotification(group, newMember.realName);
    
    saveData();
    renderGroupMembersInSettings(group);
    renderMessages(false, true);
    showToast(`新成员 ${newMember.groupNickname} 已加入`);
    createMemberForGroupModal.classList.remove('visible');
});

        document.getElementById('setting-group-my-avatar-upload').addEventListener('change', (e) => handleFileUpload(e.target.files[0], (url) => {
            document.getElementById('setting-group-my-avatar-preview').src = url;
        }));
addMemberActionSheet.addEventListener('click', e => {
    e.stopPropagation();
    if (e.target === addMemberActionSheet) {
        addMemberActionSheet.classList.remove('visible');
    }
});
createMemberForGroupModal.addEventListener('click', e => {
    e.stopPropagation();
    if (e.target === createMemberForGroupModal) {
        createMemberForGroupModal.classList.remove('visible');
    }
});
    }

    function renderMemberSelectionList() {
        memberSelectionList.innerHTML = '';
        if (db.characters.length === 0) {
            memberSelectionList.innerHTML = '<li style="color:#aaa; text-align:center; padding: 10px 0;">没有可选择的人设。</li>';
            return;
        }
        db.characters.forEach(char => {
            const li = document.createElement('li');
            li.className = 'member-selection-item';
            li.innerHTML = `<input type="checkbox" id="select-${char.id}" value="${char.id}"><img src="${char.avatar}" alt="${char.remarkName}"><label for="select-${char.id}">${char.remarkName}</label>`;
            memberSelectionList.appendChild(li);
        });
    }

    function loadGroupSettingsToSidebar() {
        const group = db.groups.find(g => g.id === currentChatId);
        if (!group) return;
        const themeSelect = document.getElementById('setting-group-theme-color');
        if (themeSelect.options.length === 0) {
            Object.keys(colorThemes).forEach(key => {
                const option = document.createElement('option'); option.value = key; option.textContent = colorThemes[key].name; themeSelect.appendChild(option);
            });
        }
        document.getElementById('setting-group-avatar-preview').src = group.avatar;
        document.getElementById('setting-group-name').value = group.name;
        document.getElementById('setting-group-my-avatar-preview').src = group.me.avatar;
        document.getElementById('setting-group-my-nickname').value = group.me.nickname;
        document.getElementById('setting-group-my-persona').value = group.me.persona;
        themeSelect.value = group.theme || 'white_pink';
        document.getElementById('setting-group-max-memory').value = group.maxMemory;
        renderGroupMembersInSettings(group);
    }
    
    function renderGroupMembersInSettings(group) {
        groupMembersListContainer.innerHTML = '';
        group.members.forEach(member => {
            const memberDiv = document.createElement('div');
            memberDiv.className = 'group-member';
            memberDiv.dataset.id = member.id;
            memberDiv.innerHTML = `<img src="${member.avatar}" alt="${member.groupNickname}"><span>${member.groupNickname}</span>`;
            groupMembersListContainer.appendChild(memberDiv);
        });
        const addBtn = document.createElement('div');
        addBtn.className = 'add-member-btn';
        addBtn.innerHTML = `<div class="add-icon">+</div><span>添加</span>`;
        groupMembersListContainer.appendChild(addBtn);
    }

    function saveGroupSettingsFromSidebar() {
        const group = db.groups.find(g => g.id === currentChatId);
        if (!group) return;
        const oldName = group.name;
        const newName = document.getElementById('setting-group-name').value;

        if (oldName !== newName) {
            group.name = newName;
            sendRenameNotification(group, newName);
        }
        
        group.avatar = document.getElementById('setting-group-avatar-preview').src;
        group.me.avatar = document.getElementById('setting-group-my-avatar-preview').src;
        group.me.nickname = document.getElementById('setting-group-my-nickname').value;
        group.me.persona = document.getElementById('setting-group-my-persona').value;
        group.theme = document.getElementById('setting-group-theme-color').value;
        group.maxMemory = document.getElementById('setting-group-max-memory').value;
        saveData();
        showToast('群聊设置已保存！');
        chatRoomTitle.textContent = group.name;
        renderChatList();
        renderMessages(false, true);
    }
    
    function openGroupMemberEditModal(memberId) {
        const group = db.groups.find(g => g.id === currentChatId);
        const member = group.members.find(m => m.id === memberId);
        if (!member) return;
        document.getElementById('edit-group-member-title').textContent = `编辑 ${member.groupNickname}`;
        document.getElementById('editing-member-id').value = member.id;
        document.getElementById('edit-member-avatar-preview').src = member.avatar;
        document.getElementById('edit-member-group-nickname').value = member.groupNickname;
        document.getElementById('edit-member-real-name').value = member.realName;
        document.getElementById('edit-member-persona').value = member.persona;
        editGroupMemberModal.classList.add('visible');
    }

    function renderInviteSelectionList() {
        inviteMemberSelectionList.innerHTML = '';
        const group = db.groups.find(g => g.id === currentChatId);
        if (!group) return;
        const currentMemberCharIds = new Set(group.members.map(m => m.originalCharId));
        const availableChars = db.characters.filter(c => !currentMemberCharIds.has(c.id));
        
        if (availableChars.length === 0) {
            inviteMemberSelectionList.innerHTML = '<li style="color:#aaa; text-align:center; padding: 10px 0;">没有可邀请的新成员了。</li>';
            confirmInviteBtn.disabled = true;
            return;
        }

        confirmInviteBtn.disabled = false;
        availableChars.forEach(char => {
            const li = document.createElement('li');
            li.className = 'invite-member-select-item';
            li.innerHTML = `
                <input type="checkbox" id="invite-select-${char.id}" value="${char.id}">
                <label for="invite-select-${char.id}">
                    <img src="${char.avatar}" alt="${char.remarkName}">
                    <span>${char.remarkName}</span>
                </label>`;
            inviteMemberSelectionList.appendChild(li);
        });
    }

    function sendInviteNotification(group, newMemberRealName) {
        const messageContent = `[${group.me.nickname}邀请${newMemberRealName}加入了群聊]`;
        const message = { id: `msg_${Date.now()}`, role: 'user', content: messageContent, timestamp: Date.now(), senderId: 'user_me' };
        group.history.push(message);
    }

    function sendRenameNotification(group, newName) {
        const myName = (currentChatType === 'private') ? group.myName : group.me.nickname;
        const messageContent = `[${myName}修改群名为：${newName}]`;
        const message = { id: `msg_${Date.now()}`, role: 'user', content: messageContent, timestamp: Date.now() };
        group.history.push(message);
    }
    
    init();
});
</script>

</body>